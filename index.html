<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Recepci√≥n de Certificados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { font-family: Arial; background: #eef1f7; margin: 0; padding: 0; }

  h1 {
    text-align: center;
    background: #3155ff;
    color: white;
    padding: 20px;
    margin: 0;
    font-size: 26px;
  }

  .container {
    width: 95%;
    max-width: 1100px;
    margin: 20px auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  label { font-weight: bold; margin-top: 10px; display: block; }

  select, input, textarea {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-transform: uppercase;
    font-size: 16px;
    box-sizing: border-box;
  }

  input[type="number"]{ text-transform: none; }

  .btn {
    width: 100%;
    padding: 12px;
    background: #3155ff;
    color: white;
    border-radius: 6px;
    border: none;
    font-size: 18px;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s;
  }

  .btn:disabled{
    opacity: .7;
    cursor: not-allowed;
  }

  .btn-estado {
    width: 100%;
    padding: 12px;
    border-radius: 6px;
    border: 2px solid transparent;
    font-size: 18px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s ease-in-out;
  }

  .btn-rechazado { background: #ffc107; color: #343a40; }
  .btn-aprobado { background: #28a745; color: white; }

  .btn-aprobado.selected {
    background: #3155ff;
    color: white;
    border-color: #3155ff;
    box-shadow: 0 0 10px rgba(49, 85, 255, 0.7);
  }

  .btn-rechazado.selected {
    background: #e0a800;
    color: white;
    border-color: #e0a800;
    box-shadow: 0 0 10px rgba(224, 168, 0, 0.7);
  }

  .status-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 15px;
  }

  #daysContainer { margin-top: 25px; }

  .header-row {
    font-weight: bold;
    padding: 10px 0;
    margin-bottom: 5px;
    border-bottom: 2px solid #3155ff;
    color: #3155ff;
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 10;
    padding-top: 15px;
  }

  /* ‚úÖ 6 columnas */
  .row, .header-row {
    display: grid;
    grid-template-columns: 140px 1fr 1fr 90px 90px 1.2fr;
    gap: 12px;
    padding-right: 15px;
  }

  .row {
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    align-items: center;
  }

  .row > div:first-child { text-align: center; }

  .msg { font-size: 12px; color: red; margin-top: 2px; text-align: left; }

  .generalBox { width: 100%; margin-top: 25px; text-transform: uppercase; }

  .ocx {
    width: 55px !important;
    text-align: center;
    font-weight: bold;
    padding: 8px !important;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-transform: uppercase;
  }

  /* ‚úÖ Barra superior */
  .topbar {
    width:95%;
    max-width:1100px;
    margin:15px auto 0 auto;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }

  .topbar-left, .topbar-right {
    display:flex;
    gap:10px;
    align-items:center;
  }

  .btn-top {
    padding:10px 20px;
    border:none;
    border-radius:6px;
    font-size:16px;
    cursor:pointer;
    color:white;
  }

  .btn-area {
    background:#ffc107; /* amarillo */
    color:#1f2a37;
    font-weight:bold;
  }

  .btn-operativo { background:#8a2be2; }
  .btn-financiero { background:#28a745; }

  /* mini estado */
  .mini {
    margin-top: 10px;
    font-size: 13px;
    color: #111827;
    background: #f3f4f6;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }

  /* ‚úÖ Quitar flechitas */
  input.no-spin::-webkit-outer-spin-button,
  input.no-spin::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  input.no-spin {
    -moz-appearance: textfield;
    appearance: textfield;
  }

  .btn-plus {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 22px;
    font-weight: bold;
    background: #3155ff;
    color: white;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* ‚úÖ NUEVO: rojo claro cuando placa NO tiene documentos */
  .placa-sin-docs {
    background: #ffe6e6 !important;
    border: 2px solid #ff4d4d !important;
  }
</style>

</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <button class="btn-top btn-area" onclick="irAreaOperativaConClave()">
      üü° AREA OPERATIVA
    </button>
  </div>

  <div class="topbar-right">
    <button class="btn-top btn-operativo" onclick="window.location.href='reportes.html'">
      üìã REPORTE OPERATIVO
    </button>

    <button class="btn-top btn-financiero" onclick="window.location.href='reporte.html'">
      üìä REPORTE FINANCIERO
    </button>
  </div>
</div>

<h1>Recepci√≥n de Certificados</h1>

<div class="container">

  <div class="mini" id="miniEstado">üîå Backend: verificando...</div>

  <label>Responsable:</label>
  <input id="responsable" placeholder="Nombre de quien registra">
  <div id="errorResp" class="msg"></div>

  <label>A√±o:</label>
  <select id="year">
    <option value="">Seleccione a√±o</option>
    <option>2025</option><option>2026</option><option>2027</option>
  </select>
  <div id="errorY" class="msg"></div>

  <label>Mes:</label>
  <select id="month">
    <option value="">Seleccione mes</option>
    <option>Enero</option><option>Febrero</option><option>Marzo</option>
    <option>Abril</option><option>Mayo</option><option>Junio</option>
    <option>Julio</option><option>Agosto</option><option>Septiembre</option>
    <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
  </select>
  <div id="errorM" class="msg"></div>

  <label>N√∫mero de Contrato - OC:</label>
  <input id="contrato" placeholder="Ejemplo: 143289">
  <div id="errorC" class="msg"></div>

  <label>N√∫mero de Ruta:</label>
  <input id="ruta" placeholder="Ejemplo: U-001">
  <div id="errorR" class="msg"></div>

  <label>Segmento:</label>
  <input id="segmento" placeholder="Ejemplo: URBANO">
  <div id="errorSegmento" class="msg"></div>

  <!-- ‚úÖ CONDUCTORES/AAR (MAX 5) - ANTES DE GENERAR D√çAS -->
  <div style="margin-top:25px;">
    <div class="header-row" style="grid-template-columns:1fr 1fr 1fr 1fr;">
      <div>CONDUCTORES</div>
      <div>ESTADO</div>
      <div>AAR</div>
      <div>ESTADO</div>
    </div>

    <div id="conductoresAarContainer">
      <div class="row" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="conductor1" placeholder="">
        <input type="text" id="estado_conductor1" placeholder="" readonly>
        <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="aar1" placeholder="">
        <input type="text" id="estado_aar1" placeholder="" readonly>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="conductor2" placeholder="">
        <input type="text" id="estado_conductor2" placeholder="" readonly>
        <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="aar2" placeholder="">
        <input type="text" id="estado_aar2" placeholder="" readonly>
      </div>

      <div class="row" style="grid-template-columns:1fr 1fr 1fr 1fr;">
        <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="conductor3" placeholder="">
        <input type="text" id="estado_conductor3" placeholder="" readonly>
        <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="aar3" placeholder="">
        <input type="text" id="estado_aar3" placeholder="" readonly>
      </div>
    </div>

    <div style="display:flex; justify-content:center; margin-top:10px;">
      <button id="btnAddCA" class="btn-plus" type="button" onclick="agregarFilaConductoresAar()" title="Agregar fila">+</button>
    </div>
  </div>

  <button class="btn" onclick="generarDias()">Generar d√≠as del mes</button>

  <div id="daysContainer"></div>

  <label>Observaci√≥n General:</label>
  <textarea class="generalBox" id="obsGeneral" rows="4" style="resize:none;"></textarea>

  <label style="margin-top:15px;">M√°ximo Transportado:</label>
  <input id="maximoTransportado" type="number" placeholder="Ejemplo: 1200">
  <div id="errorMax" class="msg"></div>

  <div id="errorEstado" class="msg" style="margin-top:10px; text-align:center;"></div>

  <div class="status-buttons">
    <button id="btnAprobado" class="btn-estado btn-aprobado" onclick="seleccionarEstado('APROBADO')">‚úî APROBADO</button>
    <button id="btnRechazado" class="btn-estado btn-rechazado" onclick="seleccionarEstado('RECHAZADO')">‚ö† RECHAZADO</button>
  </div>

  <button id="btnGuardar" class="btn" onclick="guardarDatos()">GUARDAR DATOS</button>

</div>

<script>
const API_BASE = "https://backend-recepcion-certificados.onrender.com";

function irAreaOperativaConClave() {
  const clave = prompt("Digite su contrase√±a para ingresar al √Årea Operativa:");
  if (clave === "Rutas***#*") window.location.href = "area_operativa.html";
  else if (clave === null) return;
  else alert("‚ùå Contrase√±a incorrecta.");
}

let estadoSeleccionado = null;

/* ‚úÖ Ya NO mostramos "PLACA NO AUTORIZADA"
   ‚úÖ Solo dejamos validaci√≥n de FORMATO */
const formatoPlacaRegExp = /^[A-Z]{3}[0-9]{3}$/;

function seleccionarEstado(estado) {
  document.getElementById("errorEstado").textContent = "";
  estadoSeleccionado = estado;

  const btnAprobado = document.getElementById("btnAprobado");
  const btnRechazado = document.getElementById("btnRechazado");

  btnAprobado.classList.remove('selected');
  btnRechazado.classList.remove('selected');

  if (estado === 'APROBADO') btnAprobado.classList.add('selected');
  if (estado === 'RECHAZADO') btnRechazado.classList.add('selected');
}

/* =========================
   CONDUCTORES/AAR (MAX 5)
========================= */
const CA_MAX_FILAS = 5;
let caFilaCount = 3;

function activarSoloEnterosEnInputsCA() {
  document.querySelectorAll(".ca-int").forEach(inp => {
    if (inp.dataset.caBound === "1") return;
    inp.dataset.caBound = "1";
    inp.addEventListener("input", function () {
      this.value = (this.value ?? "").toString().replace(/[^\d]/g, "");
    });
  });
}

function actualizarBotonAddCA() {
  const btn = document.getElementById("btnAddCA");
  if (!btn) return;
  btn.disabled = caFilaCount >= CA_MAX_FILAS;
  btn.style.opacity = btn.disabled ? "0.6" : "1";
  btn.title = btn.disabled ? "M√°ximo 5 filas" : "Agregar fila";
}

function agregarFilaConductoresAar() {
  if (caFilaCount >= CA_MAX_FILAS) { actualizarBotonAddCA(); return; }
  caFilaCount += 1;

  const cont = document.getElementById("conductoresAarContainer");
  const html = `
    <div class="row" style="grid-template-columns:1fr 1fr 1fr 1fr;">
      <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="conductor${caFilaCount}" placeholder="">
      <input type="text" id="estado_conductor${caFilaCount}" placeholder="" readonly>
      <input class="no-spin ca-int" inputmode="numeric" pattern="[0-9]*" type="text" id="aar${caFilaCount}" placeholder="">
      <input type="text" id="estado_aar${caFilaCount}" placeholder="" readonly>
    </div>
  `;
  cont.insertAdjacentHTML("beforeend", html);

  activarSoloEnterosEnInputsCA();
  actualizarBotonAddCA();
  activarEstadoNoDocsCA();
}

/* =====================================================
   ‚úÖ CRUCE "EXISTE O NO"
===================================================== */
function normalizarTexto(t) {
  return (t ?? "").toString().trim().toUpperCase();
}

async function existeVehiculo(placa) {
  const p = normalizarTexto(placa).replace(/[^A-Z0-9]/g, "");
  if (!p) return true;
  try {
    const r = await fetch(`${API_BASE}/vehiculo-existe/${encodeURIComponent(p)}`, { method: "GET" });
    const j = await r.json().catch(() => ({}));
    return j?.exists === true;
  } catch (e) {
    console.error("existeVehiculo error:", e);
    return true; // no bloquea si hay error
  }
}

async function existeConductor(cedula) {
  const c = (cedula ?? "").toString().trim();
  if (!c) return true;
  try {
    const r = await fetch(`${API_BASE}/existe-conductor/${encodeURIComponent(c)}`, { method: "GET" });
    const j = await r.json().catch(() => ({}));
    return j?.exists === true;
  } catch (e) {
    console.error("existeConductor error:", e);
    return true;
  }
}

async function existeAar(cedula) {
  const c = (cedula ?? "").toString().trim();
  if (!c) return true;
  try {
    const r = await fetch(`${API_BASE}/existe-aar/${encodeURIComponent(c)}`, { method: "GET" });
    const j = await r.json().catch(() => ({}));
    return j?.exists === true;
  } catch (e) {
    console.error("existeAar error:", e);
    return true;
  }
}

/* ‚úÖ CONDUCTORES/AAR -> Si NO existe, en ESTADO: NO TIENE DOCUMENTOS */
function activarEstadoNoDocsCA() {
  for (let i = 1; i <= CA_MAX_FILAS; i++) {
    const inpC = document.getElementById(`conductor${i}`);
    const outC = document.getElementById(`estado_conductor${i}`);
    if (inpC && outC && inpC.dataset.chkBound !== "1") {
      inpC.dataset.chkBound = "1";
      inpC.addEventListener("blur", async () => {
        const val = (inpC.value || "").trim();
        if (!val) { outC.value = ""; return; }
        const ok = await existeConductor(val);
        outC.value = ok ? "" : "NO TIENE DOCUMENTOS";
      });
    }

    const inpA = document.getElementById(`aar${i}`);
    const outA = document.getElementById(`estado_aar${i}`);
    if (inpA && outA && inpA.dataset.chkBound !== "1") {
      inpA.dataset.chkBound = "1";
      inpA.addEventListener("blur", async () => {
        const val = (inpA.value || "").trim();
        if (!val) { outA.value = ""; return; }
        const ok = await existeAar(val);
        outA.value = ok ? "" : "NO TIENE DOCUMENTOS";
      });
    }
  }
}

/* =====================================================
   ‚úÖ PLACAS
   - Si NO existe: input rojo claro
   - OBS: "AAA123, XXX123 PLACA SIN DOCUMENTOS" (UNA sola frase)
===================================================== */

/* Obtiene/normaliza la placa y deja vac√≠o si no hay */
function getPlacaNormalizada(inp) {
  return normalizarTexto(inp.value).replace(/[^A-Z0-9]/g, "");
}

/* Recalcula la observaci√≥n de una fila seg√∫n qu√© placas est√°n "sin docs" */
function recalcularObsFila(row) {
  const obsInp = row?.querySelector("input[data-obs]");
  if (!obsInp) return;

  // placas marcadas sin docs (guardadas en dataset del input)
  const placas = [];
  row.querySelectorAll("input.placa").forEach(p => {
    const flag = p.dataset.sinDocs === "1";
    const placa = p.dataset.placaEvaluada || "";
    if (flag && placa) placas.push(placa);
  });

  // Quitar cualquier texto previo del patr√≥n "... PLACA SIN DOCUMENTOS" que hayamos puesto nosotros
  // sin pisar otras notas del usuario:
  // - quitamos solo la parte exacta que coincide con nuestro "TAG" guardado en row.dataset.noDocsTag
  const tagPrevio = row.dataset.noDocsTag || "";
  if (tagPrevio) {
    const actual = (obsInp.value || "").toString();
    const partes = actual.split("|").map(s => s.trim()).filter(Boolean);
    const filtradas = partes.filter(p => p.toUpperCase() !== tagPrevio.toUpperCase());
    obsInp.value = filtradas.join(" | ");
    row.dataset.noDocsTag = "";
  }

  if (placas.length === 0) return;

  // Construye el nuevo TAG unido por coma:
  const tagNuevo = `${placas.join(", ")} PLACA SIN DOCUMENTOS`;

  // Insertar sin duplicar como bloque separado con " | " si ya hab√≠a texto
  const actual2 = (obsInp.value || "").toString().trim();
  if (!actual2) obsInp.value = tagNuevo;
  else obsInp.value = `${actual2} | ${tagNuevo}`;

  row.dataset.noDocsTag = tagNuevo;
}

/* Activa blur por placa:
   - consulta backend
   - pone/quita rojo claro
   - marca dataset.sinDocs y dataset.placaEvaluada
   - recalcula obs de fila para que quede unido */
function activarPlacaNoDocs() {
  document.querySelectorAll(".placa").forEach(inp => {
    if (inp.dataset.noDocsBound === "1") return;
    inp.dataset.noDocsBound = "1";

    inp.addEventListener("input", function() {
      // normaliza en tiempo real (sin mensajes rojos)
      const val = this.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
      this.value = val;
      // si edita, quitamos el rojo mientras a√∫n no validamos
      this.classList.remove("placa-sin-docs");
    });

    inp.addEventListener("blur", async () => {
      const row = inp.closest(".row");
      if (!row) return;

      const placa = getPlacaNormalizada(inp);

      // si qued√≥ vac√≠o, limpiar flags y recalcular
      if (!placa) {
        inp.dataset.sinDocs = "0";
        inp.dataset.placaEvaluada = "";
        inp.classList.remove("placa-sin-docs");
        recalcularObsFila(row);
        return;
      }

      // si formato malo, no consulta, solo marca borde rojo (como ya hac√≠as)
      // (esto NO es "no autorizada", es formato)
      if (!formatoPlacaRegExp.test(placa)) {
        inp.dataset.sinDocs = "0";
        inp.dataset.placaEvaluada = placa;
        inp.classList.remove("placa-sin-docs");
        recalcularObsFila(row);
        return;
      }

      const ok = await existeVehiculo(placa);

      inp.dataset.placaEvaluada = placa;

      if (!ok) {
        inp.dataset.sinDocs = "1";
        inp.classList.add("placa-sin-docs");   // ‚úÖ rojo claro
      } else {
        inp.dataset.sinDocs = "0";
        inp.classList.remove("placa-sin-docs");
      }

      recalcularObsFila(row);
    });
  });
}

/* =========================
   GENERAR DIAS (TU LOGICA)
========================= */
function generarDias() {
  let y = year.value;
  let m = month.value;
  let c = contrato.value.toUpperCase().trim();
  let r = ruta.value.toUpperCase().trim();
  let resp = responsable.value.toUpperCase().trim();

  errorResp.innerHTML = "";
  errorY.innerHTML = "";
  errorM.innerHTML = "";
  errorR.innerHTML = "";
  errorC.innerHTML = "";

  let err = false;

  if (!resp) { errorResp.innerHTML = "Responsable obligatorio"; err = true; }
  if (!y) { errorY.innerHTML = "A√±o obligatorio"; err = true; }
  if (!m) { errorM.innerHTML = "Mes obligatorio"; err = true; }
  if (!c) { errorC.innerHTML = "Contrato / OC es obligatorio"; err = true; }

  let regRuta = /^[A-Z]-.+$/;
  if (r.length > 0 && !regRuta.test(r)) {
    errorR.innerHTML = "Formato inv√°lido. Debe ser: Letra - (y luego cualquier cosa). Ej: U-001";
    err = true;
  }
  if (r.length === 0) {
    errorR.innerHTML = "N√∫mero de Ruta obligatorio";
    err = true;
  }

  if (err) return;

  responsable.value = resp;
  contrato.value = c;
  ruta.value = r;

  const meses = {
    "Enero":1,"Febrero":2,"Marzo":3,"Abril":4,"Mayo":5,"Junio":6,
    "Julio":7,"Agosto":8,"Septiembre":9,"Octubre":10,"Noviembre":11,"Diciembre":12
  };

  let nMes = meses[m];
  let dias = new Date(y, nMes, 0).getDate();

  daysContainer.innerHTML = `
    <div class="header-row">
      <div>FECHA</div>
      <div>PLACA R1</div>
      <div>PLACA R2</div>
      <div>OCUP. 0 R1</div>
      <div>OCUP. 0 R2</div>
      <div>OBSERVACI√ìN</div>
    </div>
  `;

  for (let d = 1; d <= dias; d++) {
    let fecha = `${d}/${nMes}/${y}`;

    daysContainer.innerHTML += `
      <div class="row">
        <div><b>${fecha}</b></div>

        <div>
          <input class="placa" data-dia="${d}" placeholder="PLACA 1">
          <div class="msg" id="msg1-${d}"></div>
        </div>

        <div>
          <input class="placa" data-dia2="${d}" placeholder="PLACA 2">
          <div class="msg" id="msg2-${d}"></div>
        </div>

        <div style="display:flex; justify-content:center;">
          <input class="ocx ocup" data-oc1="${d}" maxlength="1" placeholder="">
        </div>

        <div style="display:flex; justify-content:center;">
          <input class="ocx ocup" data-oc2="${d}" maxlength="1" placeholder="">
        </div>

        <div>
          <input class="obs" data-obs="${d}" placeholder="OBSERVACI√ìN">
        </div>
      </div>
    `;
  }

  activarValidaciones();        // ‚úÖ solo formato
  activarValidacionOcupacionX();
  activarPlacaNoDocs();         // ‚úÖ rojo + obs unido
}

function activarValidaciones() {
  document.querySelectorAll(".placa").forEach(inp => {
    inp.addEventListener("input", function() {
      let val = this.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
      this.value = val;

      let id = this.dataset.dia ? `msg1-${this.dataset.dia}` : `msg2-${this.dataset.dia2}`;
      let msgBox = document.getElementById(id);
      if (!msgBox) return;

      if (val.length === 0) msgBox.textContent = "";
      else if (!formatoPlacaRegExp.test(val)) msgBox.textContent = "FORMATO: XXX999";
      else msgBox.textContent = "";
    });
  });
}

function activarValidacionOcupacionX() {
  document.querySelectorAll(".ocup").forEach(inp => {
    inp.addEventListener("input", function () {
      let v = (this.value || "").toUpperCase().replace(/[^X]/g, "");
      this.value = v.slice(0, 1);
    });
  });
}

/* =========================
   BACKEND HELPERS (TU LOGICA)
========================= */
async function pingBackend() {
  const el = document.getElementById("miniEstado");
  try {
    const r = await fetch(`${API_BASE}/health`, { method: "GET" });
    if (!r.ok) throw new Error("Health no OK");
    const j = await r.json().catch(() => ({}));
    if (j && j.ok === true) el.textContent = "üü¢ Backend: OK";
    else el.textContent = "üü° Backend responde, pero sin {ok:true}";
  } catch (e) {
    el.textContent = "üî¥ Backend: NO responde (revisa Render / CORS / URL)";
    console.error(e);
  }
}

async function getNextIdGrupo() {
  try {
    const r = await fetch(`${API_BASE}/next-id-grupo`, { method: "GET" });
    if (!r.ok) throw new Error("next-id-grupo no OK");
    const j = await r.json();
    const v = j?.id_grupo ?? j?.next ?? j?.value;
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string" && v.trim() !== "" && !isNaN(Number(v))) return Number(v);
    throw new Error("Respuesta next-id-grupo inv√°lida");
  } catch (e) {
    const fallback = Date.now();
    console.warn("‚ö† No existe /next-id-grupo o fall√≥. Usando fallback id_grupo =", fallback);
    return fallback;
  }
}

async function postRegistros(payload) {
  const r = await fetch(`${API_BASE}/recepcion-certificados`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  let j = null;
  try { j = await r.json(); } catch (_) {}

  if (!r.ok) {
    const msg = j?.error || j?.message || `HTTP ${r.status}`;
    throw new Error(msg);
  }
  return j;
}

/* =========================
   ‚úÖ leer enteros conductor/aar para guardar
========================= */
function getIntOrNull(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = (el.value ?? "").toString().trim();
  if (v === "") return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function getTextOrNull(id) {
  const el = document.getElementById(id);
  if (!el) return null;
  const v = normalizarTexto(el.value);
  return v === "" ? null : v;
}

/* =========================
   ‚úÖ GUARDAR (queda igual: manda conductores/aar en JSON)
========================= */
async function guardarDatos() {
  if (!estadoSeleccionado) {
    document.getElementById("errorEstado").textContent = "Debe seleccionar APROBADO o RECHAZADO.";
    alert("‚ùå ERROR: Debe seleccionar APROBADO o RECHAZADO.");
    return;
  }

  const responsableV = responsable.value.toUpperCase().trim();
  const yearV = year.value;
  const monthV = month.value.toUpperCase().trim();
  const contratoV = contrato.value.toUpperCase().trim();
  const rutaV = ruta.value.toUpperCase().trim();
  let obsGeneralV = (obsGeneral.value || "").toUpperCase().trim();

  const maximoTransportadoRaw = document.getElementById("maximoTransportado").value;
  let maximoTransportadoV = (maximoTransportadoRaw === "" ? null : Number(maximoTransportadoRaw));

  if (!responsableV || !yearV || !monthV || !contratoV || !rutaV) {
    alert("TODOS LOS CAMPOS PRINCIPALES SON OBLIGATORIOS (incluyendo Responsable).");
    return;
  }

  let errorPlacaEncontrado = false;
  document.querySelectorAll(".placa").forEach(inp => {
    let placa = (inp.value || "").toUpperCase().trim();
    if (placa.length > 0 && !formatoPlacaRegExp.test(placa)) {
      errorPlacaEncontrado = true;
      inp.style.border = '2px solid red';
    } else {
      // si est√° marcado sin docs, mantenemos su estilo rojo claro
      if (!inp.classList.contains("placa-sin-docs")) inp.style.border = '1px solid #ccc';
    }
  });

  if (errorPlacaEncontrado) {
    alert("‚ùå ERROR: Una o m√°s placas tienen el formato incorrecto. Deben ser 3 letras y 3 n√∫meros (Ej: XXX999).");
    return;
  }

  if (obsGeneralV === "") obsGeneralV = null;

  const btn = document.getElementById("btnGuardar");
  btn.disabled = true;
  btn.textContent = "GUARDANDO...";

  try {
    const idGrupoV = await getNextIdGrupo();
    let registros = [];

    // ‚úÖ lee una sola vez (mismo valor para todos los d√≠as)
    const conductor1V = getIntOrNull("conductor1");
    const conductor2V = getIntOrNull("conductor2");
    const conductor3V = getIntOrNull("conductor3");
    const conductor4V = getIntOrNull("conductor4");
    const conductor5V = getIntOrNull("conductor5");

    const aar1V = getIntOrNull("aar1");
    const aar2V = getIntOrNull("aar2");
    const aar3V = getIntOrNull("aar3");
    const aar4V = getIntOrNull("aar4");
    const aar5V = getIntOrNull("aar5");

    // ‚úÖ estados (NO TIENE DOCUMENTOS o vac√≠o)
    const estadoconductor1V = getTextOrNull("estado_conductor1");
    const estadoconductor2V = getTextOrNull("estado_conductor2");
    const estadoconductor3V = getTextOrNull("estado_conductor3");
    const estadoconductor4V = getTextOrNull("estado_conductor4");
    const estadoconductor5V = getTextOrNull("estado_conductor5");

    const estadoaar1V = getTextOrNull("estado_aar1");
    const estadoaar2V = getTextOrNull("estado_aar2");
    const estadoaar3V = getTextOrNull("estado_aar3");
    const estadoaar4V = getTextOrNull("estado_aar4");
    const estadoaar5V = getTextOrNull("estado_aar5");

    document.querySelectorAll(".row").forEach(row => {
      let fechaTexto = row.querySelector("b")?.innerText;
      if (!fechaTexto) return;

      let [dia, mes, anio] = fechaTexto.split("/");
      let fechaISO = `${anio}-${String(mes).padStart(2,'0')}-${String(dia).padStart(2,'0')}`;

      let placa1 = row.querySelector("input[data-dia]")?.value.toUpperCase().trim() || null;
      let placa2 = row.querySelector("input[data-dia2]")?.value.toUpperCase().trim() || null;
      let obs = row.querySelector("input[data-obs]")?.value.toUpperCase().trim() || null;

      const oc1Raw = (row.querySelector("input[data-oc1]")?.value || "").toUpperCase().trim();
      const oc2Raw = (row.querySelector("input[data-oc2]")?.value || "").toUpperCase().trim();

      let ocupacion0R1 = (oc1Raw === "X") ? "X" : null;
      let ocupacion0R2 = (oc2Raw === "X") ? "X" : null;

      if (placa1 === "") placa1 = null;
      if (placa2 === "") placa2 = null;
      if (obs === "") obs = null;

      registros.push({
        id_grupo: idGrupoV,
        a√±o: parseInt(yearV, 10),
        mes: monthV,
        numero_ruta: rutaV,
        numero_de_contrato_oc: contratoV,
        fecha_servicio: fechaISO,
        placa_recorrido_1: placa1,
        placa_recorrido_2: placa2,
        ocupacion_0_r1: ocupacion0R1,
        ocupacion_0_r2: ocupacion0R2,
        observacion: obs,
        observacion_general: obsGeneralV,
        maximo_transportado: maximoTransportadoV,
        responsable: responsableV,
        estado: estadoSeleccionado,

        // ‚úÖ c√©dulas
        conductor1: conductor1V,
        conductor2: conductor2V,
        conductor3: conductor3V,
        conductor4: conductor4V,
        conductor5: conductor5V,
        aar1: aar1V,
        aar2: aar2V,
        aar3: aar3V,
        aar4: aar4V,
        aar5: aar5V,

        // ‚úÖ estados
        estadoconductor1: estadoconductor1V,
        estadoconductor2: estadoconductor2V,
        estadoconductor3: estadoconductor3V,
        estadoconductor4: estadoconductor4V,
        estadoconductor5: estadoconductor5V,

        estadoaar1: estadoaar1V,
        estadoaar2: estadoaar2V,
        estadoaar3: estadoaar3V,
        estadoaar4: estadoaar4V,
        estadoaar5: estadoaar5V
      });
    });

    if (registros.length === 0) {
      alert("‚ùå No hay registros para guardar. Primero genera los d√≠as del mes.");
      return;
    }

    console.log(`üì§ Enviando al backend (id_grupo=${idGrupoV})`, registros);

    const resp = await postRegistros({ id_grupo: idGrupoV, registros });

    alert(`‚úÖ Guardado exitoso. ID_GRUPO: ${idGrupoV}`);
    console.log("‚úÖ Respuesta backend:", resp);

    window.location.reload();

  } catch (e) {
    console.error("‚ùå ERROR GUARDANDO:", e);
    alert("‚ùå Error al guardar en el backend/SQL Server:\n" + (e?.message || e));
  } finally {
    btn.disabled = false;
    btn.textContent = "GUARDAR DATOS";
  }
}

/* iniciar */
pingBackend();
activarSoloEnterosEnInputsCA();
actualizarBotonAddCA();
activarEstadoNoDocsCA();
</script>

</body>
</html>

