<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S√°bana vs Certificados</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body{ font-family: Arial, sans-serif; background:#eef1f7; margin:0; padding:0; }
  .container{ width:95%; max-width:980px; background:#fff; margin:20px auto; padding:25px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  .header{ background:#ff9800; color:#111; text-align:center; padding:18px; border-radius:10px; font-size:24px; font-weight:bold; }

  label{ font-weight:bold; margin-top:12px; display:block; }
  select, input{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    margin-top:6px;
    box-sizing:border-box;
    text-transform:uppercase;
    background:#fff;
  }

  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .col{ flex:1; min-width:240px; }

  .btn{ width:100%; padding:14px; border:none; border-radius:10px; font-size:15px; font-weight:bold; cursor:pointer; margin-top:12px; }
  .btn-primary{ background:#8a2be2; color:#fff; }
  .btn-primary:hover{ background:#6a1ba0; }

  .btn-report{ background:#2b6cb0; color:#fff; }
  .btn-report:hover{ background:#1f4f84; }

  .btn-back{ background:#333; color:#fff; margin-top:16px; }
  .btn-back:hover{ background:#111; }

  .card{ margin-top:16px; padding:14px; border-radius:10px; border:1px solid #e6e6e6; background:#fafafa; }
  .ok{ color:#1b5e20; font-weight:bold; }
  .warn{ color:#8a6d3b; font-weight:bold; }
  .err{ color:#b71c1c; font-weight:bold; }

  .small{ font-size:13px; color:#555; margin-top:8px; line-height:1.35; }

  .progress{ margin-top:10px; height:10px; background:#e9e9e9; border-radius:999px; overflow:hidden; display:none; }
  .bar{ height:10px; width:0%; background:#8a2be2; transition: width .2s ease; }

  ul{ margin:10px 0 0 18px; padding:0; }
  li{ margin:6px 0; }
</style>
</head>

<body>
  <div class="container">
    <div class="header">üìë S√ÅBANA VS CERTIFICADOS</div>

    <!-- ‚úÖ LISTADO DE SABANAS CARGADAS -->
    <div class="card">
      <div style="font-weight:bold;">üìå S√°banas cargadas</div>
      <div class="small">Ejemplo: <b>DICIEMBRE-2025</b>. Si cargas el mismo mes/a√±o, se reemplaza.</div>
      <div id="listaSabanas" class="small"><span class="warn">Cargando listado...</span></div>
    </div>

    <!-- ‚úÖ FORM + BOTONES -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label for="anioServicio">A√±o de servicio:</label>
          <select id="anioServicio">
            <option value="">(Seleccione)</option>
            <option>2025</option>
            <option>2026</option>
            <option>2027</option>
          </select>
        </div>

        <div class="col">
          <label for="mesServicio">Mes de servicio:</label>
          <select id="mesServicio">
            <option value="">(Seleccione)</option>
            <option>Enero</option><option>Febrero</option><option>Marzo</option>
            <option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option>
            <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
      </div>

      <label for="fileExcel">Archivo Excel (S√°bana de Rutas):</label>
      <input id="fileExcel" type="file" accept=".xlsx,.xls" />

      <button class="btn btn-primary" onclick="cargarSabanaRutas()">
        ‚¨ÜÔ∏è CARGAR S√ÅBANA DE RUTAS (REEMPLAZA SI EXISTE MES/A√ëO)
      </button>

      <button class="btn btn-report" onclick="generarReporteCruce()">
        üìä REPORTE CERTIFICADOS RECIBIDOS VS S√ÅBANA DE RUTAS (EXCEL)
      </button>

      <div class="small">
        El Excel de s√°bana debe tener estas columnas (tal cual o muy parecido):<br>
        <b>Segmento Operaci√≥n</b>, <b>Proveedor</b>, <b>C√≥digo Ruta</b>, <b>Estado</b>.
        <br><br>
        *Se guardar√° el A√±o/Mes que selecciones arriba para todas las filas.*
      </div>

      <div class="progress" id="progressWrap">
        <div class="bar" id="progressBar"></div>
      </div>

      <div id="status" class="small"></div>
    </div>

    <button class="btn btn-back" onclick="location.href='./reportes.html'">‚¨Ö Volver a Reportes</button>
  </div>

<script>
  // ==========================
  // ‚úÖ CONFIG BACKEND (TU API)
  // ==========================
  const API_BASE = "http://localhost:10000"; // tu backend actual

  // ==========================
  // HELPERS UI
  // ==========================
  function setStatus(html){ document.getElementById("status").innerHTML = html; }

  function showProgress(pct){
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    wrap.style.display = "block";
    bar.style.width = Math.max(0, Math.min(100, pct)) + "%";
  }

  function hideProgress(){
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    wrap.style.display = "none";
    bar.style.width = "0%";
  }

  function normalizeHeader(s){
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ");
  }

  function chunkArray(arr, size){
    const out = [];
    for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
    return out;
  }

  function norm(v){
    return (v ?? "").toString().trim().toUpperCase();
  }

  // ==========================
  // API helper
  // ==========================
  async function apiFetch(path, options){
    const url = API_BASE + path;
    const res = await fetch(url, {
      headers: { "Content-Type":"application/json" },
      ...options
    });

    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch { json = null; }

    if(!res.ok){
      const msg = (json && (json.error || json.message)) ? (json.error || json.message) : (text || ("HTTP " + res.status));
      throw new Error(msg);
    }
    if(json && json.ok === false){
      throw new Error(json.error || json.message || "Error API");
    }
    return json;
  }

  // ==========================
  // LISTADO DE SABANAS CARGADAS
  // ==========================
  async function cargarListadoSabanas(){
    const el = document.getElementById("listaSabanas");
    el.innerHTML = `<span class="warn">Cargando listado...</span>`;

    try{
      const resp = await apiFetch("/sabana/list", { method:"GET" });
      const rows = resp.data || [];

      if(!rows || rows.length === 0){
        el.innerHTML = `<span class="warn">A√∫n no hay s√°banas cargadas.</span>`;
        return;
      }

      const items = rows.map(r => ({
        a√±o: (r.a√±o ?? "").toString(),
        mes: (r.mes ?? "").toString().toUpperCase(),
        registros: r.registros ?? 0
      }));

      el.innerHTML = `<ul>${items.map(it =>
        `<li><b>${it.mes}-${it.a√±o}</b> <span class="small">(registros: ${it.registros})</span></li>`
      ).join("")}</ul>`;
    }catch(e){
      console.error(e);
      el.innerHTML = `<span class="err">Error cargando listado:</span> ${e.message || e}`;
    }
  }

  // ==========================
  // CARGAR SABANA (REEMPLAZA MES/A√ëO)
  // ==========================
  async function cargarSabanaRutas(){
    try{
      setStatus("");
      hideProgress();

      const anio = document.getElementById("anioServicio").value.trim();
      const mes = document.getElementById("mesServicio").value.trim().toUpperCase();
      const file = document.getElementById("fileExcel").files[0];

      if(!anio || !mes){
        alert("Debes seleccionar A√ëO y MES de servicio antes de cargar la s√°bana.");
        return;
      }
      if(!file){
        alert("Selecciona un archivo Excel.");
        return;
      }

      const mesLabel = `${mes}-${anio}`;
      const ok = confirm(`Vas a cargar la s√°bana de ${mesLabel}.\n\nSi ya existe, se REEMPLAZA (borra y vuelve a cargar).\n\n¬øContinuar?`);
      if(!ok) return;

      setStatus(`<span class="warn">Leyendo Excel...</span>`);
      showProgress(5);

      const buffer = await file.arrayBuffer();
      const wb = XLSX.read(buffer, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const raw = XLSX.utils.sheet_to_json(ws, { defval: "" });

      if(!raw || raw.length === 0){
        alert("El Excel no tiene filas para cargar.");
        hideProgress();
        return;
      }

      // Detectar columnas (tolerante a tildes y espacios)
      const excelHeaders = Object.keys(raw[0] || {});
      const headerMap = {};
      excelHeaders.forEach(h => { headerMap[normalizeHeader(h)] = h; });

      const pick = (normKeyList) => {
        for(const k of normKeyList){
          if(headerMap[k]) return headerMap[k];
        }
        return null;
      };

      const colSeg = pick(["segmento operacion","segmento operaci√≥n","segmento"]);
      const colProv = pick(["proveedor"]);
      const colRuta = pick(["codigo ruta","c√≥digo ruta","codigo de ruta","ruta","codigo_ruta"]);
      const colEstado = pick(["estado"]);

      const faltantes = [];
      if(!colSeg) faltantes.push("Segmento Operaci√≥n");
      if(!colProv) faltantes.push("Proveedor");
      if(!colRuta) faltantes.push("C√≥digo Ruta");
      if(!colEstado) faltantes.push("Estado");

      if(faltantes.length){
        hideProgress();
        alert("Faltan columnas en el Excel: " + faltantes.join(", "));
        return;
      }

      // Convertir a formato que espera el backend
      const rowsToSend = raw.map(r => {
        const seg = norm(r[colSeg]);
        const prov = norm(r[colProv]);
        const ruta = norm(r[colRuta]);
        const est  = norm(r[colEstado]);

        if(!seg && !prov && !ruta && !est) return null;

        return {
          SegmentoOperacion: seg,
          Proveedor: prov,
          CodigoRuta: ruta,
          Estado: est
        };
      }).filter(Boolean);

      if(rowsToSend.length === 0){
        hideProgress();
        alert("No se encontraron filas v√°lidas en el Excel.");
        return;
      }

      setStatus(`<span class="warn">Enviando al servidor para reemplazar ${mesLabel}... (filas: ${rowsToSend.length})</span>`);
      showProgress(15);

      // Enviar en chunks para evitar payload gigante (10mb)
      // Ajuste: tu backend tiene express limit 10mb, por eso chunking.
      const CHUNK = 300; // ajusta si necesitas (300 suele ser seguro)
      const parts = chunkArray(rowsToSend, CHUNK);

      // Estrategia: 1er chunk lleva replace=true (borra), los dem√°s solo insert.
      // PERO como a√∫n no existe el backend, aqu√≠ mandamos TODO con un solo replace por simplicidad.
      // En el backend final haremos replace completo con body.rows grande o por lotes.
      // Para no romper por tama√±o: hacemos m√∫ltiples llamadas:
      // - primera: /sabana/replace (borra e inserta chunk)
      // - siguientes: /sabana/append (solo inserta) -> ESTE endpoint lo haremos luego.
      // Hoy: lo dejamos en modo "solo 1 llamada" y avisamos si se pasa.

      // ‚úÖ Si cabe en 10mb, hacemos 1 sola llamada:
      const payload = { anio, mes, rows: rowsToSend };

      try{
        await apiFetch("/sabana/replace", {
          method: "POST",
          body: JSON.stringify(payload)
        });

        showProgress(100);
        setStatus(`<span class="ok">‚úî S√°bana ${mesLabel} cargada/reemplazada.</span><br>Filas enviadas: <b>${rowsToSend.length}</b>`);
        alert(`‚úî S√°bana ${mesLabel} cargada/reemplazada correctamente`);

        document.getElementById("fileExcel").value = "";
        await cargarListadoSabanas();
        return;

      }catch(err){
        // Si falla por tama√±o, dejamos mensaje claro (lo resolvemos en backend con append por lotes)
        hideProgress();
        console.error(err);
        setStatus(
          `<span class="err">‚ùå Error cargando la s√°bana:</span> ${err.message}<br>
          <span class="small">Si el error es por tama√±o (payload), en el siguiente paso hacemos el backend para insertar por lotes.</span>`
        );
        alert("Error cargando la s√°bana. Revisa el mensaje en pantalla / consola.");
      }

    } catch (e){
      hideProgress();
      console.error(e);
      setStatus(`<span class="err">‚ùå Error inesperado:</span> ${e.message || e}`);
      alert("Ocurri√≥ un error inesperado. Revisa consola.");
    }
  }

  // ==========================
  // REPORTE: CERTIFICADOS VS SABANA
  // (Listo en el HTML, endpoints se crean en backend luego)
  // ==========================
  async function generarReporteCruce(){
    try{
      setStatus("");
      hideProgress();

      const anio = document.getElementById("anioServicio").value.trim();
      const mes = document.getElementById("mesServicio").value.trim().toUpperCase();

      if(!anio || !mes){
        alert("Debes seleccionar A√ëO y MES para generar el reporte.");
        return;
      }

      const mesLabel = `${mes}-${anio}`;
      setStatus(`<span class="warn">Generando reporte para ${mesLabel}...</span>`);
      showProgress(10);

      // 1) traer sabana del mes/a√±o (endpoint lo haremos en backend)
      let sabana = [];
      try{
        const respSab = await apiFetch(`/sabana/by-period?anio=${encodeURIComponent(anio)}&mes=${encodeURIComponent(mes)}`, { method:"GET" });
        sabana = respSab.data || [];
      }catch(e){
        hideProgress();
        setStatus(`<span class="err">‚ùå A√∫n falta crear el endpoint del backend:</span> <b>/sabana/by-period</b><br>${e.message}`);
        alert("Falta crear endpoints de reporte en el backend. Seguimos en el siguiente paso.");
        return;
      }

      if(!sabana || sabana.length === 0){
        hideProgress();
        setStatus(`<span class="err">No hay s√°bana cargada para ${mesLabel}.</span>`);
        alert(`No hay s√°bana cargada para ${mesLabel}.`);
        return;
      }

      showProgress(35);

      // 2) traer certificados APROBADOS del mes/a√±o (endpoint lo haremos en backend)
      let certificadosAprob = [];
      try{
        const respC = await apiFetch(`/certificados/aprobados?anio=${encodeURIComponent(anio)}&mes=${encodeURIComponent(mes)}`, { method:"GET" });
        certificadosAprob = respC.data || [];
      }catch(e){
        hideProgress();
        setStatus(`<span class="err">‚ùå A√∫n falta crear el endpoint del backend:</span> <b>/certificados/aprobados</b><br>${e.message}`);
        alert("Falta crear endpoints de reporte en el backend. Seguimos en el siguiente paso.");
        return;
      }

      showProgress(55);

      // Map ruta -> info (usar fecha m√°s antigua)
      const mapRuta = {};
      (certificadosAprob || []).forEach(r => {
        const ruta = norm(r.numero_ruta);
        if(!ruta) return;

        const fecha = (r.fecha_creacion ?? "").toString().trim();
        if(!mapRuta[ruta]){
          mapRuta[ruta] = {
            fecha_creacion: fecha,
            estado: r.estado ?? "APROBADO"
          };
        } else {
          const prev = (mapRuta[ruta].fecha_creacion || "");
          if(prev && fecha && fecha < prev){
            mapRuta[ruta].fecha_creacion = fecha;
            mapRuta[ruta].estado = r.estado ?? "APROBADO";
          }
        }
      });

      // 3) hoja 1 cruce
      const cruce = sabana.map(s => {
        const ruta = norm(s["C√≥digo Ruta"] ?? s.CodigoRuta ?? s.codigo_ruta ?? "");
        const info = mapRuta[ruta];

        return {
          a√±o: s.a√±o ?? anio,
          mes: (s.mes ?? mes).toString().toUpperCase(),
          "Segmento Operaci√≥n": s["Segmento Operaci√≥n"] ?? s.SegmentoOperacion ?? s.segmento_operacion ?? "",
          "Proveedor": s["Proveedor"] ?? s.Proveedor ?? "",
          "C√≥digo Ruta": s["C√≥digo Ruta"] ?? s.CodigoRuta ?? s.codigo_ruta ?? "",
          "Estado (S√°bana)": s["Estado"] ?? s.Estado ?? "",

          CERTIFICADO_RECIBIDO: info ? "SI" : "NO",
          FECHA_RECIBIDO: info ? (info.fecha_creacion || "") : "",
          ESTADO_CERTIFICADO: info ? (info.estado || "APROBADO") : ""
        };
      });

      showProgress(75);

      // 4) hoja 2 resumen por proveedor
      const resumen = {};
      cruce.forEach(r => {
        const prov = (r["Proveedor"] ?? "").toString().trim().toUpperCase() || "SIN PROVEEDOR";
        if(!resumen[prov]){
          resumen[prov] = { PROVEEDOR: prov, TOTAL_RUTAS: 0, RECIBIDOS: 0, PENDIENTES: 0, _fechas: new Set() };
        }
        resumen[prov].TOTAL_RUTAS += 1;
        if(r.CERTIFICADO_RECIBIDO === "SI"){
          resumen[prov].RECIBIDOS += 1;
          if(r.FECHA_RECIBIDO) resumen[prov]._fechas.add(r.FECHA_RECIBIDO);
        }
      });

      const resumenArr = Object.values(resumen).map(x => {
        x.PENDIENTES = x.TOTAL_RUTAS - x.RECIBIDOS;
        const fechas = Array.from(x._fechas).sort();
        delete x._fechas;
        x.FECHAS_RECIBIDAS = fechas.join(", ");
        return x;
      }).sort((a,b)=> a.PROVEEDOR.localeCompare(b.PROVEEDOR));

      // 5) export excel
      const columnasCruce = [
        "a√±o","mes","Segmento Operaci√≥n","Proveedor","C√≥digo Ruta","Estado (S√°bana)",
        "CERTIFICADO_RECIBIDO","FECHA_RECIBIDO","ESTADO_CERTIFICADO"
      ];

      const columnasResumen = [
        "PROVEEDOR","TOTAL_RUTAS","RECIBIDOS","PENDIENTES","FECHAS_RECIBIDAS"
      ];

      const ws1 = XLSX.utils.json_to_sheet(cruce, { header: columnasCruce });
      const ws2 = XLSX.utils.json_to_sheet(resumenArr, { header: columnasResumen });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, "CRUCE");
      XLSX.utils.book_append_sheet(wb, ws2, "RESUMEN_PROVEEDOR");

      const filename = `reporte_certificados_vs_sabana_${mesLabel}.xlsx`;
      XLSX.writeFile(wb, filename);

      showProgress(100);
      setStatus(`<span class="ok">‚úî Reporte generado:</span> ${filename}<br>Filas s√°bana: <b>${sabana.length}</b> | Certificados APROBADO: <b>${(certificadosAprob||[]).length}</b>`);
      alert("‚úî Reporte generado correctamente");

    }catch(e){
      hideProgress();
      console.error(e);
      setStatus(`<span class="err">‚ùå Error:</span> ${e.message || e}`);
      alert("Error generando reporte. Revisa consola.");
    }
  }

  // init
  (async ()=>{
    await cargarListadoSabanas();
  })();
</script>

</body>
</html>
