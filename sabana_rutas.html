<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S√°bana vs Certificados</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body{ font-family: Arial, sans-serif; background:#eef1f7; margin:0; padding:0; }
  .container{ width:95%; max-width:900px; background:#fff; margin:20px auto; padding:25px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  .header{ background:#ff9800; color:#111; text-align:center; padding:18px; border-radius:10px; font-size:24px; font-weight:bold; }

  label{ font-weight:bold; margin-top:12px; display:block; }
  select, input{ width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:6px; box-sizing:border-box; text-transform:uppercase; background:#fff; }

  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .col{ flex:1; min-width:240px; }

  .btn{ width:100%; padding:14px; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer; margin-top:12px; }
  .btn-primary{ background:#8a2be2; color:#fff; }
  .btn-primary:hover{ background:#6a1ba0; }

  .btn-test{ background:#2b6cb0; color:#fff; }
  .btn-test:hover{ background:#1f4f84; }

  .btn-back{ background:#333; color:#fff; margin-top:16px; }
  .btn-back:hover{ background:#111; }

  .card{ margin-top:16px; padding:14px; border-radius:10px; border:1px solid #e6e6e6; background:#fafafa; }
  .ok{ color:#1b5e20; font-weight:bold; }
  .warn{ color:#8a6d3b; font-weight:bold; }
  .err{ color:#b71c1c; font-weight:bold; }

  .small{ font-size:13px; color:#555; margin-top:8px; line-height:1.35; }

  .progress{ margin-top:10px; height:10px; background:#e9e9e9; border-radius:999px; overflow:hidden; display:none; }
  .bar{ height:10px; width:0%; background:#8a2be2; transition: width .2s ease; }
</style>
</head>

<body>
  <div class="container">
    <div class="header">üìë S√ÅBANA VS CERTIFICADOS</div>

    <div class="card">
      <div class="row">
        <div class="col">
          <label for="anioServicio">A√±o de servicio:</label>
          <select id="anioServicio">
            <option value="">(Seleccione)</option>
            <option>2025</option>
            <option>2026</option>
            <option>2027</option>
          </select>
        </div>

        <div class="col">
          <label for="mesServicio">Mes de servicio:</label>
          <select id="mesServicio">
            <option value="">(Seleccione)</option>
            <option>Enero</option><option>Febrero</option><option>Marzo</option>
            <option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option>
            <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
      </div>

      <label for="fileExcel">Archivo Excel (S√°bana de Rutas):</label>
      <input id="fileExcel" type="file" accept=".xlsx,.xls" />

      <!-- ‚úÖ NUEVO: Probar conexi√≥n -->
      <button class="btn btn-test" onclick="probarConexion()">
        üîå PROBAR CONEXI√ìN SUPABASE
      </button>

      <button class="btn btn-primary" onclick="cargarSabanaRutas()">
        ‚¨ÜÔ∏è CARGAR S√ÅBANA DE RUTAS
      </button>

      <div class="small">
        El Excel debe tener estas columnas (tal cual o muy parecido):<br>
        <b>A√±o</b>, <b>Mes</b>, <b>Segmento Operaci√≥n</b>, <b>Proveedor</b>, <b>C√≥digo Ruta</b>, <b>Estado</b>.
        <br><br>
        *Se guardar√° el A√±o/Mes que selecciones arriba para todas las filas.*
      </div>

      <div class="progress" id="progressWrap">
        <div class="bar" id="progressBar"></div>
      </div>

      <div id="status" class="small"></div>
    </div>

    <button class="btn btn-back" onclick="location.href='reportes.html'">‚¨Ö Volver a Reportes</button>
  </div>

<script>
  // ==========================
  // ‚úÖ SUPABASE CONFIG (TU INFO)
  // ==========================
  const SUPABASE_URL = "https://vdsqkhajbfevpgeuvfbd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkc3FraGFqYmZldnBnZXV2ZmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDg3MTIsImV4cCI6MjA3OTE4NDcxMn0.OexzIcRC_F7pnFijSQGZVpXN1xdsDw8zuGR1gFHTyuI";

  // ‚úÖ AJUSTE CLAVE: forzar headers apikey + Authorization
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    }
  });

  // ==========================
  // HELPERS UI
  // ==========================
  function setStatus(html){ document.getElementById("status").innerHTML = html; }

  function showProgress(pct){
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    wrap.style.display = "block";
    bar.style.width = Math.max(0, Math.min(100, pct)) + "%";
  }

  function hideProgress(){
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    wrap.style.display = "none";
    bar.style.width = "0%";
  }

  function normalizeHeader(s){
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ");
  }

  function chunkArray(arr, size){
    const out = [];
    for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
    return out;
  }

  // ==========================
  // ‚úÖ PROBAR CONEXI√ìN
  // ==========================
  async function probarConexion(){
    try{
      setStatus(`<span class="warn">Probando conexi√≥n...</span>`);
      // una consulta simple
      const { data, error } = await client.from("sabana_rutas").select("*").limit(1);

      if(error){
        console.error(error);
        setStatus(`<span class="err">‚ùå Error de conexi√≥n:</span> ${error.message}`);
        alert("Conexi√≥n fallida. Revisa el error en pantalla/console.");
        return;
      }

      setStatus(`<span class="ok">‚úÖ Conexi√≥n OK.</span> Puedes cargar el Excel.`);
      alert("‚úÖ Conexi√≥n Supabase OK");
    } catch(e){
      console.error(e);
      setStatus(`<span class="err">‚ùå Error inesperado:</span> ${e.message || e}`);
      alert("Error inesperado. Revisa consola.");
    }
  }

  // ==========================
  // MAIN: CARGAR SABANA
  // ==========================
  async function cargarSabanaRutas(){
    try{
      setStatus("");
      hideProgress();

      const anio = document.getElementById("anioServicio").value.trim();
      const mes = document.getElementById("mesServicio").value.trim().toUpperCase();
      const file = document.getElementById("fileExcel").files[0];

      if(!anio || !mes){
        alert("Debes seleccionar A√ëO y MES de servicio antes de cargar la s√°bana.");
        return;
      }
      if(!file){
        alert("Selecciona un archivo Excel.");
        return;
      }

      setStatus(`<span class="warn">Leyendo Excel...</span>`);
      showProgress(5);

      const buffer = await file.arrayBuffer();
      const wb = XLSX.read(buffer, { type: "array" });

      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      const raw = XLSX.utils.sheet_to_json(ws, { defval: "" });

      if(!raw || raw.length === 0){
        alert("El Excel no tiene filas para cargar.");
        hideProgress();
        return;
      }

      const excelHeaders = Object.keys(raw[0] || {});
      const headerMap = {};
      excelHeaders.forEach(h => { headerMap[normalizeHeader(h)] = h; });

      const pick = (normKeyList) => {
        for(const k of normKeyList){
          if(headerMap[k]) return headerMap[k];
        }
        return null;
      };

      const colSeg = pick(["segmento operacion","segmento operaci√≥n","segmento"]);
      const colProv = pick(["proveedor"]);
      const colRuta = pick(["codigo ruta","c√≥digo ruta","codigo de ruta","ruta","codigo_ruta"]);
      const colEstado = pick(["estado"]);

      const faltantes = [];
      if(!colSeg) faltantes.push("Segmento Operaci√≥n");
      if(!colProv) faltantes.push("Proveedor");
      if(!colRuta) faltantes.push("C√≥digo Ruta");
      if(!colEstado) faltantes.push("Estado");

      if(faltantes.length){
        hideProgress();
        alert("Faltan columnas en el Excel: " + faltantes.join(", "));
        return;
      }

      // ‚ö†Ô∏è IMPORTANTE: aqu√≠ uso los nombres EXACTOS que dijiste:
      // a√±o, mes, Segmento Operaci√≥n, Proveedor, C√≥digo Ruta, Estado
      const rowsToInsert = raw.map(r => {
        const seg = (r[colSeg] ?? "").toString().trim().toUpperCase();
        const prov = (r[colProv] ?? "").toString().trim().toUpperCase();
        const ruta = (r[colRuta] ?? "").toString().trim().toUpperCase();
        const est  = (r[colEstado] ?? "").toString().trim().toUpperCase();

        if(!seg && !prov && !ruta && !est) return null;

        return {
          a√±o: anio,
          mes: mes,
          "Segmento Operaci√≥n": seg,
          "Proveedor": prov,
          "C√≥digo Ruta": ruta,
          "Estado": est
        };
      }).filter(Boolean);

      if(rowsToInsert.length === 0){
        hideProgress();
        alert("No se encontraron filas v√°lidas en el Excel.");
        return;
      }

      setStatus(`
        <span class="warn">Preparando carga...</span><br>
        Filas del Excel: <b>${raw.length}</b><br>
        Filas v√°lidas a insertar: <b>${rowsToInsert.length}</b>
      `);

      const BATCH = 500;
      const chunks = chunkArray(rowsToInsert, BATCH);

      let insertedTotal = 0;

      for(let i=0;i<chunks.length;i++){
        const pct = Math.round(10 + ((i / chunks.length) * 85));
        showProgress(pct);

        const { data, error } = await client
          .from("sabana_rutas")
          .insert(chunks[i]);

        if(error){
          hideProgress();
          console.error(error);
          setStatus(`<span class="err">‚ùå Error insertando lote ${i+1}/${chunks.length}:</span> ${error.message}`);
          alert("Error cargando la s√°bana. Revisa consola.");
          return;
        }

        insertedTotal += (data ? data.length : chunks[i].length);
      }

      showProgress(100);
      setStatus(`<span class="ok">‚úî Carga completada.</span><br>Filas insertadas: <b>${insertedTotal}</b>`);
      alert("‚úî S√°bana cargada correctamente en la tabla sabana_rutas");

    } catch (e){
      hideProgress();
      console.error(e);
      setStatus(`<span class="err">‚ùå Error inesperado:</span> ${e.message || e}`);
      alert("Ocurri√≥ un error inesperado. Revisa consola.");
    }
  }
</script>

</body>
</html>
