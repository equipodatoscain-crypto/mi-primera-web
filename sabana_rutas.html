<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>S√°bana vs Certificados</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body{ font-family: Arial, sans-serif; background:#eef1f7; margin:0; padding:0; }
  .container{ width:95%; max-width:980px; background:#fff; margin:20px auto; padding:25px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  .header{ background:#ff9800; color:#111; text-align:center; padding:18px; border-radius:10px; font-size:24px; font-weight:bold; }

  label{ font-weight:bold; margin-top:12px; display:block; }
  select, input{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    margin-top:6px;
    box-sizing:border-box;
    text-transform:uppercase;
    background:#fff;
  }

  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .col{ flex:1; min-width:240px; }

  .btn{ width:100%; padding:14px; border:none; border-radius:10px; font-size:15px; font-weight:bold; cursor:pointer; margin-top:12px; }
  .btn-primary{ background:#8a2be2; color:#fff; }
  .btn-primary:hover{ background:#6a1ba0; }

  .btn-report{ background:#2b6cb0; color:#fff; }
  .btn-report:hover{ background:#1f4f84; }

  .btn-back{ background:#333; color:#fff; margin-top:16px; }
  .btn-back:hover{ background:#111; }

  .card{ margin-top:16px; padding:14px; border-radius:10px; border:1px solid #e6e6e6; background:#fafafa; }
  .ok{ color:#1b5e20; font-weight:bold; }
  .warn{ color:#8a6d3b; font-weight:bold; }
  .err{ color:#b71c1c; font-weight:bold; }

  .small{ font-size:13px; color:#555; margin-top:8px; line-height:1.35; }

  .progress{ margin-top:10px; height:10px; background:#e9e9e9; border-radius:999px; overflow:hidden; display:none; }
  .bar{ height:10px; width:0%; background:#8a2be2; transition: width .2s ease; }

  ul{ margin:10px 0 0 18px; padding:0; }
  li{ margin:6px 0; }
</style>
</head>

<body>
  <div class="container">
    <div class="header">üìë S√ÅBANA VS CERTIFICADOS</div>

    <!-- ‚úÖ LISTADO DE SABANAS CARGADAS -->
    <div class="card">
      <div style="font-weight:bold;">üìå S√°banas cargadas</div>
      <div class="small">Ejemplo: <b>DICIEMBRE-2025</b>. Si cargas el mismo mes/a√±o, se reemplaza.</div>
      <div id="listaSabanas" class="small"><span class="warn">Cargando listado...</span></div>
    </div>

    <!-- ‚úÖ FORM + BOTONES -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label for="anioServicio">A√±o de servicio:</label>
          <select id="anioServicio">
            <option value="">(Seleccione)</option>
            <option>2025</option>
            <option>2026</option>
            <option>2027</option>
          </select>
        </div>

        <div class="col">
          <label for="mesServicio">Mes de servicio:</label>
          <select id="mesServicio">
            <option value="">(Seleccione)</option>
            <option>Enero</option><option>Febrero</option><option>Marzo</option>
            <option>Abril</option><option>Mayo</option><option>Junio</option>
            <option>Julio</option><option>Agosto</option><option>Septiembre</option>
            <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
          </select>
        </div>
      </div>

      <label for="fileExcel">Archivo Excel (S√°bana de Rutas):</label>
      <input id="fileExcel" type="file" accept=".xlsx,.xls" />

      <button class="btn btn-primary" onclick="cargarSabanaRutas()">
        ‚¨ÜÔ∏è CARGAR S√ÅBANA DE RUTAS (REEMPLAZA SI EXISTE MES/A√ëO)
      </button>

      <button class="btn btn-report" onclick="generarReporteCruce()">
        üìä REPORTE CERTIFICADOS RECIBIDOS VS S√ÅBANA DE RUTAS (EXCEL)
      </button>

      <div class="small">
        El Excel de s√°bana debe tener estas columnas (tal cual o muy parecido):<br>
        <b>A√±o</b>, <b>Mes</b>, <b>Segmento Operaci√≥n</b>, <b>Proveedor</b>, <b>C√≥digo Ruta</b>, <b>Estado</b>.
        <br><br>
        *Se guardar√° el A√±o/Mes que selecciones arriba para todas las filas.*
      </div>

      <div class="progress" id="progressWrap">
        <div class="bar" id="progressBar"></div>
      </div>

      <div id="status" class="small"></div>
    </div>

    <button class="btn btn-back" onclick="location.href='./reportes.html'">‚¨Ö Volver a Reportes</button>
  </div>

<script>
  // ==========================
  // ‚úÖ SUPABASE CONFIG
  // ==========================
  const SUPABASE_URL = "https://vdsqkhajbfevpgeuvfbd.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkc3FraGFqYmZldnBnZXV2ZmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDg3MTIsImV4cCI6MjA3OTE4NDcxMn0.OexzIcRC_F7pnFijSQGZVpXN1xdsDw8zuGR1gFHTyuI";

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    }
  });

  // ==========================
  // HELPERS UI
  // ==========================
  function setStatus(html){ document.getElementById("status").innerHTML = html; }

  function showProgress(pct){
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    wrap.style.display = "block";
    bar.style.width = Math.max(0, Math.min(100, pct)) + "%";
  }

  function hideProgress(){
    const wrap = document.getElementById("progressWrap");
    const bar = document.getElementById("progressBar");
    wrap.style.display = "none";
    bar.style.width = "0%";
  }

  function normalizeHeader(s){
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ");
  }

  function chunkArray(arr, size){
    const out = [];
    for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
    return out;
  }

  function norm(v){
    return (v ?? "").toString().trim().toUpperCase();
  }

  function titleCaseMes(mesUpper){
    const m = (mesUpper || "").toString().trim().toLowerCase();
    if(!m) return "";
    return m.charAt(0).toUpperCase() + m.slice(1);
  }

  // ==========================
  // FETCH ALL (paginaci√≥n)
  // ==========================
  async function fetchAll(table, selectStr, filtersFn){
    let page = 0;
    let rows = [];
    const limit = 1000;

    while(true){
      let q = client.from(table).select(selectStr).range(page*limit, page*limit + limit - 1);
      if (filtersFn) q = filtersFn(q);

      const { data, error } = await q;
      if(error) throw error;

      rows = rows.concat(data || []);
      if(!data || data.length < limit) break;
      page++;
    }
    return rows;
  }

  // ==========================
  // LISTADO DE SABANAS CARGADAS
  // ==========================
  async function cargarListadoSabanas(){
    const el = document.getElementById("listaSabanas");
    el.innerHTML = `<span class="warn">Cargando listado...</span>`;

    try{
      const rows = await fetchAll(
        "sabana_rutas",
        "a√±o, mes",
        (q) => q
      );

      if(!rows || rows.length === 0){
        el.innerHTML = `<span class="warn">A√∫n no hay s√°banas cargadas.</span>`;
        return;
      }

      const map = {};
      rows.forEach(r => {
        const a = norm(r.a√±o);
        const m = norm(r.mes);
        if(!a || !m) return;
        const key = `${a}|${m}`;
        map[key] = (map[key] || 0) + 1;
      });

      const items = Object.keys(map).map(k => {
        const [a,m] = k.split("|");
        return { a√±o:a, mes:m, count: map[k] };
      });

      items.sort((x,y)=>{
        if(x.a√±o !== y.a√±o) return y.a√±o.localeCompare(x.a√±o);
        return x.mes.localeCompare(y.mes);
      });

      el.innerHTML = `<ul>${items.map(it =>
        `<li><b>${it.mes}-${it.a√±o}</b> <span class="small">(registros: ${it.count})</span></li>`
      ).join("")}</ul>`;
    }catch(e){
      console.error(e);
      el.innerHTML = `<span class="err">Error cargando listado:</span> ${e.message || e}`;
    }
  }

  // ==========================
  // CARGAR SABANA (REEMPLAZA MES/A√ëO)
  // ==========================
  async function cargarSabanaRutas(){
    try{
      setStatus("");
      hideProgress();

      const anio = document.getElementById("anioServicio").value.trim();
      const mes = document.getElementById("mesServicio").value.trim().toUpperCase();
      const file = document.getElementById("fileExcel").files[0];

      if(!anio || !mes){
        alert("Debes seleccionar A√ëO y MES de servicio antes de cargar la s√°bana.");
        return;
      }
      if(!file){
        alert("Selecciona un archivo Excel.");
        return;
      }

      const mesLabel = `${mes}-${anio}`;
      const ok = confirm(`Vas a cargar la s√°bana de ${mesLabel}.\n\nSi ya existe, se REEMPLAZA (borra y vuelve a cargar).\n\n¬øContinuar?`);
      if(!ok) return;

      setStatus(`<span class="warn">Leyendo Excel...</span>`);
      showProgress(5);

      const buffer = await file.arrayBuffer();
      const wb = XLSX.read(buffer, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const raw = XLSX.utils.sheet_to_json(ws, { defval: "" });

      if(!raw || raw.length === 0){
        alert("El Excel no tiene filas para cargar.");
        hideProgress();
        return;
      }

      const excelHeaders = Object.keys(raw[0] || {});
      const headerMap = {};
      excelHeaders.forEach(h => { headerMap[normalizeHeader(h)] = h; });

      const pick = (normKeyList) => {
        for(const k of normKeyList){
          if(headerMap[k]) return headerMap[k];
        }
        return null;
      };

      const colSeg = pick(["segmento operacion","segmento operaci√≥n","segmento"]);
      const colProv = pick(["proveedor"]);
      const colRuta = pick(["codigo ruta","c√≥digo ruta","codigo de ruta","ruta","codigo_ruta"]);
      const colEstado = pick(["estado"]);

      const faltantes = [];
      if(!colSeg) faltantes.push("Segmento Operaci√≥n");
      if(!colProv) faltantes.push("Proveedor");
      if(!colRuta) faltantes.push("C√≥digo Ruta");
      if(!colEstado) faltantes.push("Estado");

      if(faltantes.length){
        hideProgress();
        alert("Faltan columnas en el Excel: " + faltantes.join(", "));
        return;
      }

      const rowsToInsert = raw.map(r => {
        const seg = norm(r[colSeg]);
        const prov = norm(r[colProv]);
        const ruta = norm(r[colRuta]);
        const est  = norm(r[colEstado]);

        if(!seg && !prov && !ruta && !est) return null;

        return {
          a√±o: anio,
          mes: mes,
          "Segmento Operaci√≥n": seg,
          "Proveedor": prov,
          "C√≥digo Ruta": ruta,
          "Estado": est
        };
      }).filter(Boolean);

      if(rowsToInsert.length === 0){
        hideProgress();
        alert("No se encontraron filas v√°lidas en el Excel.");
        return;
      }

      // 1) DELETE existente para ese mes/a√±o
      setStatus(`<span class="warn">Reemplazando: eliminando datos anteriores de ${mesLabel}...</span>`);
      showProgress(15);

      const { error: delError } = await client
        .from("sabana_rutas")
        .delete()
        .match({ a√±o: anio, mes: mes });

      if(delError){
        hideProgress();
        console.error(delError);
        const msg = (delError.message || "").toLowerCase();
        if(msg.includes("row-level security")){
          setStatus(`<span class="err">‚ùå RLS bloque√≥ el DELETE.</span> Debes crear policy <b>DELETE</b> para sabana_rutas (role public).<br>${delError.message}`);
          alert("No se pudo reemplazar: RLS bloque√≥ el DELETE.");
        }else{
          setStatus(`<span class="err">‚ùå Error eliminando:</span> ${delError.message}`);
          alert("Error eliminando datos anteriores. Revisa consola.");
        }
        return;
      }

      // 2) INSERT en lotes
      setStatus(`<span class="warn">Insertando nueva s√°bana (${rowsToInsert.length} filas)...</span>`);
      showProgress(25);

      const BATCH = 500;
      const chunks = chunkArray(rowsToInsert, BATCH);

      let insertedTotal = 0;
      for(let i=0;i<chunks.length;i++){
        const pct = Math.round(25 + ((i / chunks.length) * 70));
        showProgress(pct);

        const { data, error } = await client
          .from("sabana_rutas")
          .insert(chunks[i]);

        if(error){
          hideProgress();
          console.error(error);
          setStatus(`<span class="err">‚ùå Error insertando lote ${i+1}/${chunks.length}:</span> ${error.message}`);
          alert("Error cargando la s√°bana. Revisa consola.");
          return;
        }

        insertedTotal += (data ? data.length : chunks[i].length);
      }

      showProgress(100);
      setStatus(`<span class="ok">‚úî S√°bana ${mesLabel} cargada/reemplazada.</span><br>Filas insertadas: <b>${insertedTotal}</b>`);
      alert(`‚úî S√°bana ${mesLabel} cargada/reemplazada correctamente`);

      document.getElementById("fileExcel").value = "";
      await cargarListadoSabanas();

    } catch (e){
      hideProgress();
      console.error(e);
      setStatus(`<span class="err">‚ùå Error inesperado:</span> ${e.message || e}`);
      alert("Ocurri√≥ un error inesperado. Revisa consola.");
    }
  }

  // ==========================
  // REPORTE: CERTIFICADOS VS SABANA
  // ==========================
  async function generarReporteCruce(){
    try{
      setStatus("");
      hideProgress();

      const anio = document.getElementById("anioServicio").value.trim();
      const mes = document.getElementById("mesServicio").value.trim().toUpperCase();

      if(!anio || !mes){
        alert("Debes seleccionar A√ëO y MES para generar el reporte.");
        return;
      }

      const mesLabel = `${mes}-${anio}`;
      setStatus(`<span class="warn">Generando reporte para ${mesLabel}...</span>`);
      showProgress(10);

      // 1) traer sabana del mes/a√±o
      const sabana = await fetchAll(
        "sabana_rutas",
        'a√±o, mes, "Segmento Operaci√≥n", "Proveedor", "C√≥digo Ruta", "Estado"',
        (q) => q.eq("a√±o", anio).eq("mes", mes)
      );

      if(!sabana || sabana.length === 0){
        hideProgress();
        setStatus(`<span class="err">No hay s√°bana cargada para ${mesLabel}.</span>`);
        alert(`No hay s√°bana cargada para ${mesLabel}.`);
        return;
      }

      showProgress(35);

      // 2) traer certificados del mes/a√±o (APROBADO) para cruce
      const certificadosAprob = await fetchAll(
        "recepcion_certificados",
        "fecha_creacion, a√±o, mes, numero_de_contrato_oc, numero_ruta, responsable, estado, observacion_general",
        (q) => q.eq("a√±o", anio).eq("mes", mes).eq("estado", "APROBADO")
      );

      showProgress(55);

      // Map ruta -> info (usar fecha m√°s antigua)
      const mapRuta = {};
      (certificadosAprob || []).forEach(r => {
        const ruta = norm(r.numero_ruta);
        if(!ruta) return;

        const fecha = (r.fecha_creacion ?? "").toString().trim();
        if(!mapRuta[ruta]){
          mapRuta[ruta] = {
            fecha_creacion: fecha,
            numero_de_contrato_oc: r.numero_de_contrato_oc ?? "",
            responsable: r.responsable ?? "",
            estado: r.estado ?? "",
            observacion_general: r.observacion_general ?? ""
          };
        } else {
          // quedarnos con la fecha menor (m√°s antigua)
          const prev = (mapRuta[ruta].fecha_creacion || "");
          if(prev && fecha && fecha < prev){
            mapRuta[ruta].fecha_creacion = fecha;
            mapRuta[ruta].numero_de_contrato_oc = r.numero_de_contrato_oc ?? "";
            mapRuta[ruta].responsable = r.responsable ?? "";
            mapRuta[ruta].estado = r.estado ?? "";
            mapRuta[ruta].observacion_general = r.observacion_general ?? "";
          }
        }
      });

      // 3) hoja 1 cruce
      const cruce = sabana.map(s => {
        const ruta = norm(s["C√≥digo Ruta"]);
        const info = mapRuta[ruta];

        return {
          a√±o: s.a√±o,
          mes: s.mes,
          "Segmento Operaci√≥n": s["Segmento Operaci√≥n"],
          "Proveedor": s["Proveedor"],
          "C√≥digo Ruta": s["C√≥digo Ruta"],
          "Estado (S√°bana)": s["Estado"],

          CERTIFICADO_RECIBIDO: info ? "SI" : "NO",
          FECHA_RECIBIDO: info ? (info.fecha_creacion || "") : "",
          ESTADO_CERTIFICADO: info ? (info.estado || "APROBADO") : ""
        };
      });

      showProgress(75);

      // 4) hoja 2 resumen por proveedor
      const resumen = {};
      cruce.forEach(r => {
        const prov = (r["Proveedor"] ?? "").toString().trim().toUpperCase() || "SIN PROVEEDOR";
        if(!resumen[prov]){
          resumen[prov] = { PROVEEDOR: prov, TOTAL_RUTAS: 0, RECIBIDOS: 0, PENDIENTES: 0, _fechas: new Set() };
        }
        resumen[prov].TOTAL_RUTAS += 1;
        if(r.CERTIFICADO_RECIBIDO === "SI"){
          resumen[prov].RECIBIDOS += 1;
          if(r.FECHA_RECIBIDO) resumen[prov]._fechas.add(r.FECHA_RECIBIDO);
        }
      });

      const resumenArr = Object.values(resumen).map(x => {
        x.PENDIENTES = x.TOTAL_RUTAS - x.RECIBIDOS;
        const fechas = Array.from(x._fechas).sort();
        delete x._fechas;
        x.FECHAS_RECIBIDAS = fechas.join(", ");
        return x;
      }).sort((a,b)=> a.PROVEEDOR.localeCompare(b.PROVEEDOR));

      // 5) export excel
      const columnasCruce = [
        "a√±o","mes","Segmento Operaci√≥n","Proveedor","C√≥digo Ruta","Estado (S√°bana)",
        "CERTIFICADO_RECIBIDO","FECHA_RECIBIDO","ESTADO_CERTIFICADO","CONTRATO_OC","RESPONSABLE","OBSERVACION_GENERAL"
      ];

      const columnasResumen = [
        "PROVEEDOR","TOTAL_RUTAS","RECIBIDOS","PENDIENTES","FECHAS_RECIBIDAS"
      ];

      const ws1 = XLSX.utils.json_to_sheet(cruce, { header: columnasCruce });
      const ws2 = XLSX.utils.json_to_sheet(resumenArr, { header: columnasResumen });

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, "CRUCE");
      XLSX.utils.book_append_sheet(wb, ws2, "RESUMEN_PROVEEDOR");

      const filename = `reporte_certificados_vs_sabana_${mesLabel}.xlsx`;
      XLSX.writeFile(wb, filename);

      showProgress(100);
      setStatus(`<span class="ok">‚úî Reporte generado:</span> ${filename}<br>Filas s√°bana: <b>${sabana.length}</b> | Certificados APROBADO: <b>${(certificadosAprob||[]).length}</b>`);
      alert("‚úî Reporte generado correctamente");

    }catch(e){
      hideProgress();
      console.error(e);
      const msg = e?.message || e;
      if((msg+"").toLowerCase().includes("row-level security")){
        setStatus(`<span class="err">‚ùå RLS bloque√≥ el SELECT.</span> Debes permitir SELECT en recepcion_certificados y sabana_rutas (role public).<br>${msg}`);
      }else{
        setStatus(`<span class="err">‚ùå Error:</span> ${msg}`);
      }
      alert("Error generando reporte. Revisa consola.");
    }
  }

  // init
  (async ()=>{
    await cargarListadoSabanas();
  })();
</script>

</body>
</html>

