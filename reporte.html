<script>
async function generarReporte() {

    // 1. Definimos el orden y los nombres EXACTOS de las columnas de la BD que queremos.
    // **Ajusté "responsable" y "estado" a MAYÚSCULAS según la imagen de tu tabla.**
    const dbColumns = [
        "id",
        "fecha_creacion",
        "año",
        "mes",
        "numero_de_contrato_oc", // Nombre de la BD
        "numero_ruta",
        "fecha_servicio",
        "placa_recorrido_1",
        "placa_recorrido_2",
        "observacion_recorrido",
        "observacion_general",
        "RESPONSABLE",           // Nombre de la BD (asumimos Mayúsculas)
        "ESTADO"                 // Nombre de la BD (asumimos Mayúsculas)
    ];

    // 2. Mapeamos los nombres de la BD a los títulos en MAYÚSCULAS para el Excel.
    // Usaremos esta lista para la primera fila del Excel.
    const excelHeaders = {
        "id": "ID",
        "fecha_creacion": "FECHA_CREACION",
        "año": "AÑO",
        "mes": "MES",
        "numero_de_contrato_oc": "NUMERO_DE_CONTRATO_OC",
        "numero_ruta": "NUMERO_RUTA",
        "fecha_servicio": "FECHA_SERVICIO",
        "placa_recorrido_1": "PLACA_RECORRIDO_1",
        "placa_recorrido_2": "PLACA_RECORRIDO_2",
        "observacion_recorrido": "OBSERVACION_RECORRIDO",
        "observacion_general": "OBSERVACION_GENERAL",
        "RESPONSABLE": "RESPONSABLE", // Mantienen el mismo nombre en este caso
        "ESTADO": "ESTADO"           // Mantienen el mismo nombre en este caso
    };


    // CAPTURA DE VALORES DEL FORMULARIO
    let yearV = document.getElementById("year").value;
    let monthV = document.getElementById("month").value;
    let contratoV = document.getElementById("contrato").value.toUpperCase().trim();
    let rutaV = document.getElementById("ruta").value.toUpperCase().trim();
    let responsableV = document.getElementById("responsable").value.toUpperCase().trim();
    let estadoV = document.getElementById("estado").value.toUpperCase().trim();

    // CONSULTA INICIAL: Solo pedimos las columnas definidas en dbColumns
    let query = client.from("recepcion_certificados").select(dbColumns.join(","), { head: false });

    // APLICACIÓN DE FILTROS
    if (yearV) query = query.eq("año", parseInt(yearV));
    if (monthV) query = query.eq("mes", monthV.toUpperCase());
    if (contratoV) query = query.eq("numero_de_contrato_oc", contratoV);
    if (rutaV) query = query.eq("numero_ruta", rutaV);
    // **Nota:** Usamos los nombres de columna exactos para el filtro
    if (responsableV) query = query.eq("RESPONSABLE", responsableV); 
    if (estadoV) query = query.eq("ESTADO", estadoV);                 

    const { data, error } = await query;

    if (error) {
        console.error(error);
        alert("Error consultando Supabase");
        return;
    }

    if (data.length === 0) {
        alert("No hay datos con esos filtros.");
        return;
    }

    // --- GENERACIÓN DE EXCEL ---
    // 1. Crear la hoja de cálculo. data ya solo contiene las columnas que queremos.
    const hoja = XLSX.utils.json_to_sheet(data, { 
        header: dbColumns // Usamos la lista de la BD para asegurar el orden
    });

    // 2. Cambiamos los nombres de los encabezados de la primera fila al formato deseado (MAYÚSCULAS)
    // Mapeamos los nombres de las columnas de la BD (dbColumns) a los títulos de Excel (excelHeaders).
    XLSX.utils.sheet_add_aoa(hoja, [
        dbColumns.map(colName => excelHeaders[colName]) 
    ], { origin: "A1" });

    // 3. Exportar a Excel
    const libro = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(libro, hoja, "Reporte");
    XLSX.writeFile(libro, "reporte_certificados.xlsx");

    alert("Excel generado correctamente ✔");
}
</script>
