<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Certificados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
Â  Â  const SUPABASE_URL = "https://vdsqkhajbfevpgeuvfbd.supabase.co";
Â  Â  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkc3FraGFqYmZldnBnZXV2ZmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDg3MTIsImV4cCI6MjA3OTE4NDcxMn0.OexzIcRC_F7pnFijSQGZVpXN1xdsDw8zuGR1gFHTyuI";

Â  Â  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<style>
Â  Â  body {
Â  Â  Â  Â  font-family: Arial;
Â  Â  Â  Â  background: #eef1f7;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  }

Â  Â  .container {
Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  max-width: 700px;
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
Â  Â  }

Â  Â  h1 {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  padding: 18px;
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  border-radius: 0 0 10px 10px;
Â  Â  }

Â  Â  label {
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  display: block;
Â  Â  }

Â  Â  select, input {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  }

Â  Â  .btn {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  background: #28a745;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  font-size: 18px;
Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  }

Â  Â  .btn:hover {
Â  Â  Â  Â  background: #1e8a38;
Â  Â  }
</style>

</head>
<body>

<div class="container">

Â  Â  <h1>ðŸ“Š Reporte de Certificados</h1>

Â  Â  <label>AÃ±o:</label>
Â  Â  <select id="year">
Â  Â  Â  Â  <option value="">(Todos)</option>
Â  Â  Â  Â  <option>2025</option>
Â  Â  Â  Â  <option>2026</option>
Â  Â  Â  Â  <option>2027</option>
Â  Â  </select>

Â  Â  <label>Mes:</label>
Â  Â  <select id="month">
Â  Â  Â  Â  <option value="">(Todos)</option>
Â  Â  Â  Â  <option>Enero</option>
Â  Â  Â  Â  <option>Febrero</option>
Â  Â  Â  Â  <option>Marzo</option>
Â  Â  Â  Â  <option>Abril</option>
Â  Â  Â  Â  <option>Mayo</option>
Â  Â  Â  Â  <option>Junio</option>
Â  Â  Â  Â  <option>Julio</option>
Â  Â  Â  Â  <option>Agosto</option>
Â  Â  Â  Â  <option>Septiembre</option>
Â  Â  Â  Â  <option>Octubre</option>
Â  Â  Â  Â  <option>Noviembre</option>
Â  Â  Â  Â  <option>Diciembre</option>
Â  Â  </select>

Â  Â  <label>NÃºmero de Contrato - OC:</label>
Â  Â  <input id="contrato" placeholder="Ej: OC-2025-001">

Â  Â  <label>NÃºmero de Ruta:</label>
Â  Â  <input id="ruta" placeholder="Ej: Y-001">

Â  Â  <button class="btn" onclick="generarReporte()">GENERAR REPORTE (EXCEL)</button>

</div>

<script>
async function generarReporte() {

Â  Â  /* ðŸŸ¢ 1. Pide contraseÃ±a antes de generar */
Â  Â  let pass = prompt("Ingrese contraseÃ±a para generar el reporte:");

Â  Â  if (pass !== "Rutas2025#*#") {
Â  Â  Â  Â  alert("âŒ ContraseÃ±a incorrecta. No se generÃ³ el reporte.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  /* ðŸŸ¢ 2. Obtener filtros */
Â  Â  let yearV = document.getElementById("year").value;
Â  Â  let monthV = document.getElementById("month").value;
Â  Â  let contratoV = document.getElementById("contrato").value.toUpperCase().trim();
Â  Â  let rutaV = document.getElementById("ruta").value.toUpperCase().trim();

Â  Â  let query = client.from("recepcion_certificados").select("*", { head: false });

Â  Â  if (yearV) query = query.eq("aÃ±o", parseInt(yearV));
Â  Â  if (monthV) query = query.eq("mes", monthV.toUpperCase());
Â  Â  if (contratoV) query = query.eq("numero_de_contrato_oc", contratoV);
Â  Â  if (rutaV) query = query.eq("numero_ruta", rutaV);

Â  Â  const { data, error } = await query;

Â  Â  if (error) {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  alert("Error consultando Supabase");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (data.length === 0) {
Â  Â  Â  Â  alert("No hay datos con esos filtros.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  /* ðŸŸ¢ 3. Mapear y reordenar datos al formato deseado (DD-MM-YYYY) */
Â  Â  const datosReporte = data.map(row => {
Â  Â  Â  Â  // ConversiÃ³n de fecha YYYY-MM-DD â†’ DD-MM-YYYY
Â  Â  Â  Â  let fechaServicioFormateada = row.fecha_servicio;
Â  Â  Â  Â  if (row.fecha_servicio) {
Â  Â  Â  Â  Â  Â  const p = row.fecha_servicio.split("-");
Â  Â  Â  Â  Â  Â  fechaServicioFormateada = `${p[2]}-${p[1]}-${p[0]}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Retorna un nuevo objeto con el orden de columnas deseado y los nuevos campos
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  "ID": row.id,
Â  Â  Â  Â  Â  Â  "FECHA_CREACION": row.fecha_creacion,
Â  Â  Â  Â  Â  Â  "AÃ‘O": row.aÃ±o,
Â  Â  Â  Â  Â  Â  "MES": row.mes,
Â  Â  Â  Â  Â  Â  "NUMERO_DE_CONTRATO_OC": row.numero_de_contrato_oc,
Â  Â  Â  Â  Â  Â  "NUMERO_RUTA": row.numero_ruta,
Â  Â  Â  Â  Â  Â  "FECHA_SERVICIO": fechaServicioFormateada,
Â  Â  Â  Â  Â  Â  "PLACA_RECORRIDO_1": row.placa_recorrido_1,
Â  Â  Â  Â  Â  Â  "PLACA_RECORRIDO_2": row.placa_recorrido_2,
Â  Â  Â  Â  Â  Â  "OBSERVACION_RECORRIDO": row.observacion, // Nota: el nombre de la columna en Supabase es "observacion"
Â  Â  Â  Â  Â  Â  "OBSERVACION_GENERAL": row.observacion_general,
            // Las nuevas columnas que deben coincidir con la base de datos
            "RESPONSABLE": row.RESPONSABLE || 'N/A', 
            "ESTADO": row.ESTADO || 'N/A'
Â  Â  Â  Â  };
Â  Â  });

Â  Â  /* ðŸŸ¢ 4. Crear Excel a partir de los datos reordenados */
Â  Â  const hoja = XLSX.utils.json_to_sheet(datosReporte);
Â  Â  const libro = XLSX.utils.book_new();
Â  Â  XLSX.utils.book_append_sheet(libro, hoja, "Reporte");

Â  Â  /* ðŸŸ¢ 5. Descargar archivo Excel */
Â  Â  XLSX.writeFile(libro, "reporte_certificados.xlsx");

Â  Â  alert("âœ” Reporte generado correctamente");
}
</script>

</body>
</html>
