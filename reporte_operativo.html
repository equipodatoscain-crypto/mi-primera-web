<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte Operativo de Certificados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body{font-family:Arial;background:#eef1f7;margin:0;padding:0;}
  .container{width:95%;max-width:900px;background:#fff;margin:20px auto;padding:25px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  .header{background:#8a2be2;color:#fff;text-align:center;padding:18px;border-radius:10px;font-size:28px;font-weight:bold;display:flex;justify-content:center;gap:10px;}
  h2{margin:15px 0 10px 0;}
  label{font-weight:bold;margin-top:10px;display:block;}
  select,input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-top:5px;text-transform:uppercase;box-sizing:border-box;}
  .btn{width:100%;padding:12px;background:#8a2be2;color:#fff;border:none;border-radius:8px;font-size:18px;margin-top:18px;cursor:pointer;}
  .btn:hover{background:#6a1ba0;}
  .btn-back{width:100%;padding:12px;background:#333;color:#fff;border:none;border-radius:8px;font-size:16px;margin-top:14px;cursor:pointer;}
  .btn-back:hover{background:#111;}
  .status{margin-top:12px;font-size:13px;line-height:1.35;color:#444;}
  .ok{color:#1b5e20;font-weight:bold;}
  .warn{color:#8a6d3b;font-weight:bold;}
  .err{color:#b71c1c;font-weight:bold;}
</style>
</head>

<body>
<div class="container">
  <div class="header">üìã Reportes</div>

  <h2>üìä Reporte Operativo</h2>

  <label>A√±o:</label>
  <select id="year">
    <option value="">(Todos)</option>
    <option>2025</option>
    <option>2026</option>
    <option>2027</option>
  </select>

  <label>Mes:</label>
  <select id="month">
    <option value="">(Todos)</option>
    <option>Enero</option><option>Febrero</option><option>Marzo</option>
    <option>Abril</option><option>Mayo</option><option>Junio</option>
    <option>Julio</option><option>Agosto</option><option>Septiembre</option>
    <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
  </select>

  <label>N√∫mero de Contrato - OC:</label>
  <input id="contrato" placeholder="Ej: OC-2025-001">

  <label>N√∫mero de Ruta:</label>
  <input id="ruta" placeholder="Ej: Y-001">

  <label>Responsable:</label>
  <input id="responsable" placeholder="Nombre del responsable">

  <label>Estado:</label>
  <select id="estado">
    <option value="">(Todos)</option>
    <option>APROBADO</option>
    <option>RECHAZADO</option>
  </select>

  <button class="btn" onclick="generarReporteOperativo()">GENERAR REPORTE OPERATIVO (EXCEL)</button>
  <button class="btn-back" onclick="window.location.href='./reportes.html'">‚¨Ö Volver a Reportes</button>

  <div id="status" class="status"></div>
</div>

<script>
  const SUPABASE_URL = "https://vdsqkhajbfevpgeuvfbd.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkc3FraGFqYmZldnBnZXV2ZmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDg3MTIsImV4cCI6MjA3OTE4NDcxMn0.OexzIcRC_F7pnFijSQGZVpXN1xdsDw8zuGR1gFHTyuI";

  // ‚úÖ MISMO ARREGLO QUE EN sabana_rutas.html (evita Invalid API key por headers)
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    }
  });

  function setStatus(html){ document.getElementById("status").innerHTML = html; }
  function norm(v){ return (v ?? "").toString().trim().toUpperCase(); }

  // ‚úÖ PAGINACI√ìN ILIMITADA
  async function fetchAllRows() {
    let page = 0;
    let rows = [];
    const limit = 1000;

    while (true) {
      const { data, error } = await client
        .from("recepcion_certificados")
        .select("*")
        .range(page * limit, page * limit + limit - 1);

      if (error) throw error;

      rows = rows.concat(data || []);
      if (!data || data.length < limit) break;
      page++;
    }
    return rows;
  }

  // ‚úÖ REPORTE OPERATIVO (1 fila por fecha_creacion+a√±o+mes+ruta+responsable)
  async function generarReporteOperativo() {
    try{
      setStatus(`<span class="warn">Consultando Supabase...</span>`);

      const allData = await fetchAllRows();

      if(!allData || allData.length === 0){
        setStatus(`<span class="err">Supabase devolvi√≥ 0 filas.</span> Si antes hab√≠a datos, revisa RLS/Policy SELECT en <b>recepcion_certificados</b>.`);
        alert("Supabase devolvi√≥ 0 filas.");
        return;
      }

      const yearV = norm(year.value);
      const monthV = norm(month.value);
      const contratoV = norm(contrato.value);
      const rutaV = norm(ruta.value);
      const responsableV = norm(responsable.value);
      const estadoV = norm(estado.value);

      const filtrados = allData.filter(row => {
        const rowYear = norm(row.a√±o);
        const rowMes = norm(row.mes);
        const rowContrato = norm(row.numero_de_contrato_oc);
        const rowRuta = norm(row.numero_ruta);
        const rowResp = norm(row.responsable);
        const rowEstado = norm(row.estado);

        if (yearV && rowYear !== yearV) return false;
        if (monthV && rowMes !== monthV) return false;
        if (contratoV && rowContrato !== contratoV) return false;
        if (rutaV && rowRuta !== rutaV) return false;
        if (responsableV && rowResp !== responsableV) return false;
        if (estadoV && rowEstado !== estadoV) return false;

        return true;
      });

      if (filtrados.length === 0) {
        setStatus(`<span class="warn">No hay datos para esos filtros.</span> (Pero Supabase s√≠ respondi√≥: ${allData.length} filas le√≠das)`);
        alert("No hay datos para estos filtros.");
        return;
      }

      const resumen = {};
      filtrados.forEach(row => {
        const key = [
          norm(row.fecha_creacion),
          norm(row.a√±o),
          norm(row.mes),
          norm(row.numero_ruta),
          norm(row.responsable)
        ].join("|");

        if (!resumen[key]) resumen[key] = row;
      });

      const salida = Object.values(resumen);
      salida.sort((a,b)=> norm(a.numero_ruta).localeCompare(norm(b.numero_ruta)));

      const columnas = [
        "fecha_creacion",
        "a√±o",
        "mes",
        "numero_de_contrato_oc",
        "numero_ruta",
        "responsable",
        "estado",
        "observacion_general"
      ];

      const salidaOrdenada = salida.map(row => {
        const nuevo = {};
        columnas.forEach(col => nuevo[col] = row[col]);
        return nuevo;
      });

      const hoja = XLSX.utils.json_to_sheet(salidaOrdenada, { header: columnas });
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Operativo");
      XLSX.writeFile(libro, "reporte_operativo_certificados.xlsx");

      setStatus(`<span class="ok">‚úî Reporte generado.</span> Filas: <b>${salidaOrdenada.length}</b>`);
      alert("‚úî Reporte Operativo generado correctamente");
    }catch(err){
      console.error(err);
      const msg = (err?.message || JSON.stringify(err));

      // ‚úÖ mensajes claros
      if ((msg+"").toLowerCase().includes("invalid api key")){
        setStatus(`<span class="err">‚ùå Invalid API key.</span> Haz <b>Ctrl+F5</b> (cach√©) y confirma que este archivo es el que est√°s abriendo.`);
      } else if ((msg+"").toLowerCase().includes("row-level security")){
        setStatus(`<span class="err">‚ùå RLS bloque√≥ el SELECT</span> en <b>recepcion_certificados</b>. Debes crear policy SELECT para public.`);
      } else {
        setStatus(`<span class="err">‚ùå Error:</span> ${msg}`);
      }

      alert("ERROR: " + msg);
    }
  }
</script>

</body>
</html>
