<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reportes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body{font-family: Arial, sans-serif;background:#eef1f7;margin:0;padding:0;}
  .container{width:95%;max-width:900px;background:#fff;margin:20px auto;padding:25px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  .header{background:#8a2be2;color:#fff;text-align:center;padding:18px;border-radius:10px;font-size:28px;font-weight:bold;display:flex;justify-content:center;gap:10px;}
  .menu{display:flex;gap:15px;margin-top:18px;flex-wrap:wrap;}
  .menu button{flex:1;min-width:260px;padding:16px;border:none;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;}
  .btn-operativo{background:#8a2be2;color:#fff;}
  .btn-operativo:hover{background:#6a1ba0;}
  .btn-sabana{background:#ff9800;color:#111;}
  .btn-sabana:hover{background:#e68900;}
  .hidden{display:none;}
  h2{margin:10px 0 15px 0;}
  label{font-weight:bold;margin-top:10px;display:block;}
  select,input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;margin-top:5px;text-transform:uppercase;box-sizing:border-box;}
  .btn{width:100%;padding:12px;background:#8a2be2;color:#fff;border:none;border-radius:8px;font-size:18px;margin-top:18px;cursor:pointer;}
  .btn:hover{background:#6a1ba0;}
  .btn-back{width:100%;padding:12px;background:#333;color:#fff;border:none;border-radius:8px;font-size:16px;margin-top:14px;cursor:pointer;}
  .btn-back:hover{background:#111;}
</style>
</head>

<body>
<div class="container">

  <div class="header">üìã Reportes</div>

  <div id="menuPrincipal" class="menu">
    <button class="btn-operativo" onclick="abrirVista('operativo')">üìä REPORTE OPERATIVO</button>
    <button class="btn-sabana" onclick="location.href='sabana_rutas.html'">üìë S√ÅBANA VS CERTIFICADOS</button>
  </div>

  <div id="vistaOperativo" class="hidden">
    <h2>üìä Reporte Operativo</h2>

    <label>A√±o:</label>
    <select id="year">
      <option value="">(Todos)</option>
      <option>2025</option>
      <option>2026</option>
      <option>2027</option>
    </select>

    <label>Mes:</label>
    <select id="month">
      <option value="">(Todos)</option>
      <option>Enero</option><option>Febrero</option><option>Marzo</option>
      <option>Abril</option><option>Mayo</option><option>Junio</option>
      <option>Julio</option><option>Agosto</option><option>Septiembre</option>
      <option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
    </select>

    <label>N√∫mero de Contrato - OC:</label>
    <input id="contrato" placeholder="Ej: OC-2025-001">

    <label>N√∫mero de Ruta:</label>
    <input id="ruta" placeholder="Ej: Y-001">

    <label>Responsable:</label>
    <input id="responsable" placeholder="Nombre del responsable">

    <label>Estado:</label>
    <select id="estado">
      <option value="">(Todos)</option>
      <option>APROBADO</option>
      <option>RECHAZADO</option>
    </select>

    <button class="btn" onclick="generarReporteOperativo()">GENERAR REPORTE OPERATIVO (EXCEL)</button>
    <button class="btn-back" onclick="volverMenu()">‚¨Ö Volver a Reportes</button>
  </div>

</div>

<script>
  const SUPABASE_URL = "https://vdsqkhajbfevpgeuvfbd.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmZldnBnZXV2ZmJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDg3MTIsImV4cCI6MjA3OTE4NDcxMn0.OexzIcRC_F7pnFijSQGZVpXN1xdsDw8zuGR1gFHTyuI";

  // (Opcional pero ayuda): forzar headers como en sabana_rutas
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    }
  });

  function abrirVista(tipo){
    document.getElementById("menuPrincipal").classList.add("hidden");
    document.getElementById("vistaOperativo").classList.add("hidden");
    if(tipo === "operativo") document.getElementById("vistaOperativo").classList.remove("hidden");
  }

  function volverMenu(){
    document.getElementById("vistaOperativo").classList.add("hidden");
    document.getElementById("menuPrincipal").classList.remove("hidden");
  }

  // Normalizador robusto
  function norm(v){
    return (v ?? "")
      .toString()
      .trim()
      .toUpperCase();
  }

  async function fetchAllRows() {
    let page = 0;
    let rows = [];
    const limit = 1000;

    while (true) {
      const { data, error } = await client
        .from("recepcion_certificados")
        .select("*")
        .range(page * limit, page * limit + limit - 1);

      if (error) {
        // ‚úÖ Aqu√≠ estaba el problema: antes solo lo imprim√≠a y segu√≠a.
        console.error("ERROR SELECT recepcion_certificados:", error);
        throw new Error(error.message || "Error consultando recepcion_certificados");
      }

      rows = rows.concat(data || []);
      if (!data || data.length < limit) break;
      page++;
    }
    return rows;
  }

  async function generarReporteOperativo() {
    try{
      const allData = await fetchAllRows();

      // Si Supabase devuelve 0 filas, lo avisamos claro
      if(!allData || allData.length === 0){
        alert("Supabase devolvi√≥ 0 registros. Revisa RLS/Policies de SELECT en recepcionpcion_certificados.");
        return;
      }

      const yearV = norm(year.value);
      const monthV = norm(month.value);         // ENERO, FEBRERO...
      const contratoV = norm(contrato.value);
      const rutaV = norm(ruta.value);
      const responsableV = norm(responsable.value);
      const estadoV = norm(estado.value);

      // ‚úÖ Comparaci√≥n normalizada (quita espacios/casos raros)
      const filtrados = allData.filter(row => {
        const rowYear = norm(row.a√±o);
        const rowMes = norm(row.mes);
        const rowContrato = norm(row.numero_de_contrato_oc);
        const rowRuta = norm(row.numero_ruta);
        const rowResp = norm(row.responsable);
        const rowEstado = norm(row.estado);

        if (yearV && rowYear !== yearV) return false;
        if (monthV && rowMes !== monthV) return false;
        if (contratoV && rowContrato !== contratoV) return false;
        if (rutaV && rowRuta !== rutaV) return false;
        if (responsableV && rowResp !== responsableV) return false;
        if (estadoV && rowEstado !== estadoV) return false;

        return true;
      });

      if (filtrados.length === 0) {
        alert(
          "No hay datos para estos filtros.\n\n" +
          "TIP: si antes hab√≠a datos, revisa en Supabase si activaste RLS en recepcion_certificados sin Policy SELECT."
        );
        return;
      }

      // Agrupaci√≥n
      const resumen = {};
      filtrados.forEach(row => {
        const key = [
          norm(row.fecha_creacion),
          norm(row.a√±o),
          norm(row.mes),
          norm(row.numero_ruta),
          norm(row.responsable)
        ].join("|");
        if (!resumen[key]) resumen[key] = row;
      });

      const salida = Object.values(resumen);

      // Orden por ruta
      salida.sort((a, b) => norm(a.numero_ruta).localeCompare(norm(b.numero_ruta)));

      const columnas = [
        "fecha_creacion",
        "a√±o",
        "mes",
        "numero_de_contrato_oc",
        "numero_ruta",
        "responsable",
        "estado",
        "observacion_general"
      ];

      const salidaOrdenada = salida.map(row => {
        const nuevo = {};
        columnas.forEach(col => nuevo[col] = row[col]);
        return nuevo;
      });

      const hoja = XLSX.utils.json_to_sheet(salidaOrdenada, { header: columnas });
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Operativo");
      XLSX.writeFile(libro, "reporte_operativo_certificados.xlsx");

      alert("‚úî Reporte Operativo generado correctamente");
    }catch(e){
      console.error(e);
      alert("ERROR real: " + (e.message || e));
    }
  }
</script>
</body>
</html>
